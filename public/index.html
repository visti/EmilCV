<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Emil Visti - Workbench</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' shape-rendering='crispEdges'><rect width='16' height='16' fill='%230055aa'/><rect x='2' y='2' width='12' height='12' fill='%23fff' rx='0'/><rect x='3' y='3' width='10' height='3' fill='%230055aa'/><rect x='5' y='3' width='4' height='2' fill='%23fff'/><rect x='3' y='7' width='10' height='6' fill='%23aaccff'/><rect x='4' y='8' width='8' height='4' fill='%230055aa'/></svg>">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Silkscreen:wght@400;700&display=swap');

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: #0055aa;
      color: #ffffff;
      font-family: 'Silkscreen', 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.4;
      min-height: 100vh;
      padding: 4px;
      cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16'%3E%3Cpath d='M0 0L0 14L4 10L7 15L9 14L6 9L11 9Z' fill='%23ff8800' stroke='%23000' stroke-width='1'/%3E%3C/svg%3E") 0 0, auto;
    }

    /* Workbench title bar at top of screen */
    .wb-screen-bar {
      background: linear-gradient(to bottom, #ffffff 0%, #aaaaee 100%);
      color: #0033aa;
      padding: 2px 8px;
      font-size: 13px;
      font-weight: 700;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #000;
      margin-bottom: 8px;
    }
    .wb-screen-bar .gadgets {
      display: flex;
      gap: 2px;
    }
    .wb-screen-bar .gadget {
      width: 18px;
      height: 14px;
      border: 2px solid #000;
      background: #aaaacc;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      cursor: default;
    }

    /* Amiga-style window */
    .window {
      background: #0055aa;
      border: 2px solid #ffffff;
      margin-bottom: 8px;
      box-shadow: 2px 2px 0 #000;
      resize: both;
      overflow: hidden;
      min-width: 220px;
      min-height: 80px;
      max-width: 100%;
    }

    .window-title {
      background: linear-gradient(to bottom, #6688cc 0%, #4466aa 100%);
      color: #ffffff;
      padding: 2px 6px;
      font-size: 13px;
      font-weight: 700;
      display: flex;
      align-items: center;
      border-bottom: 2px solid #fff;
      user-select: none;
    }
    .window-title .close-gadget {
      width: 16px;
      height: 12px;
      border: 2px solid #fff;
      background: #0055aa;
      margin-right: 6px;
      flex-shrink: 0;
    }
    .window-title .title-text {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
    }

    .window-body {
      padding: 8px 10px;
    }

    /* Content styling */
    .prompt-text {
      color: #ffaa00;
      font-weight: 700;
    }
    .cmd-text {
      color: #ffffff;
    }
    .output-text {
      color: #aaccff;
    }
    .dim-text {
      color: #6699cc;
    }
    .highlight {
      color: #ffaa00;
    }
    .star-text {
      color: #ffaa00;
    }
    .bar-text {
      color: #ffaa00;
    }

    a {
      color: #ffaa00;
      text-decoration: none;
    }
    a:hover {
      color: #ffdd44;
      text-decoration: underline;
    }

    .cursor {
      display: inline-block;
      width: 8px;
      height: 14px;
      background: #ffaa00;
      animation: blink 1s step-end infinite;
      vertical-align: text-bottom;
    }
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50%      { opacity: 0; }
    }
    /* Boot sequence overlay */
    .boot-screen {
      position: fixed;
      inset: 0;
      background: #001244;
      color: #aaccff;
      font-family: 'Silkscreen', 'Courier New', monospace;
      font-size: 14px;
      z-index: 9999;
      display: none;
      padding: 16px;
    }
    .boot-screen.active {
      display: block;
    }
    .boot-box {
      border: 2px solid #fff;
      background: #002266;
      box-shadow: 2px 2px 0 #000;
      padding: 12px;
      max-width: 640px;
    }
    .boot-line {
      margin-bottom: 6px;
    }
    #boot-hand {
      display: block;
      width: 260px;
      height: auto;
      margin: 8px 0 12px;
      image-rendering: pixelated;
      border: 2px solid #fff;
      background: #001244;
    }

    #main-window .window-body {
      padding-right: 10px;
      overflow: auto;
      scrollbar-color: #6688cc #4466aa;
      scrollbar-width: auto;
    }
    #main-window .window-body::-webkit-scrollbar {
      width: 16px;
    }
    #main-window .window-body::-webkit-scrollbar-track {
      background: #4466aa;
      border-left: 2px solid #fff;
    }
    #main-window .window-body::-webkit-scrollbar-thumb {
      background: #6688cc;
      border: 2px solid #fff;
      box-shadow: inset 0 0 0 2px #4466aa;
    }
    #main-window .window-body::-webkit-scrollbar-button:single-button {
      display: block;
      height: 16px;
      background: #6688cc;
      border: 2px solid #fff;
    }
    /* Icon row at bottom */
    .icon-row {
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
      padding: 12px 8px;
    }
    .wb-icon {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      cursor: inherit;
      text-decoration: none;
      color: #fff;
      width: 90px;
    }
    .wb-icon:hover {
      color: #ffaa00;
    }
    .icon-box {
      width: 48px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .icon-box svg {
      width: 100%;
      height: 100%;
      filter: drop-shadow(2px 2px 0 #000);
    }
    .icon-label {
      font-size: 11px;
      text-align: center;
      white-space: pre-line;
    }

    .line {
      opacity: 0;
      transition: opacity 0.04s;
    }
    .line.visible {
      opacity: 1;
    }
    #demo-body {
      padding: 6px;
      position: relative;
      overflow: hidden;
    }
    #demo-canvas {
      display: block;
      width: 100%;
      height: 100%;
      border: 2px solid #fff;
      background: #001a44;
      image-rendering: pixelated;
    }
    /* Disk pie window */
    #disk-window {
      min-width: 360px;
      min-height: 260px;
    }
    #disk-body {
      padding: 6px;
      background: #001a44;
    }
    #disk-canvas {
      display: block;
      width: 100%;
      height: 100%;
      border: 2px solid #fff;
      background: #001244;
      image-rendering: pixelated;
    }
    /* File manager */
    #filemgr-window {
      min-width: 520px;
      min-height: 280px;
    }
    #filemgr-body {
      display: flex;
      gap: 8px;
      padding: 6px;
      background: #002266;
      height: 100%;
    }
    .fm-pane {
      background: #001a44;
      border: 2px solid #fff;
      box-shadow: 2px 2px 0 #000;
      padding: 6px;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    .fm-left {
      width: 200px;
      flex: 0 0 200px;
    }
    .fm-right {
      flex: 1;
      min-width: 0;
    }
    .fm-path {
      font-size: 10px;
      color: #ffdd44;
      text-transform: uppercase;
      margin-bottom: 6px;
      letter-spacing: 0.5px;
    }
    .fm-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
      overflow: auto;
    }
    .fm-item {
      display: flex;
      align-items: center;
      gap: 6px;
      color: #aaccff;
      text-decoration: none;
      padding: 2px 4px;
      border: 1px solid transparent;
      cursor: inherit;
    }
    .fm-item.active {
      border-color: #ffdd44;
      color: #ffdd44;
    }
    .fm-folder {
      width: 14px;
      height: 10px;
      background: #ffaa00;
      border: 1px solid #ffdd44;
      box-shadow: 1px 1px 0 #000;
    }
    .fm-title {
      font-size: 11px;
      color: #ffdd44;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    #filemgr-canvas {
      display: block;
      width: 100%;
      height: 100%;
      border: 2px solid #fff;
      background: #001244;
      image-rendering: pixelated;
    }
    #scroller {
      position: absolute;
      left: 0;
      top: 0;
      right: auto;
      bottom: auto;
      pointer-events: none;
      overflow: hidden;
      clip-path: inset(2px);
      white-space: nowrap;
      font-size: 160px;
      letter-spacing: 3px;
      color: #ffdd44;
      text-transform: uppercase;
      text-shadow: 0 2px 0 #ff6600, 0 0 8px rgba(255, 136, 0, 0.8);
      font-weight: 700;
    }
    #scroller span {
      display: inline-block;
      min-width: 10px;
    }

    /* === Deluxe Paint window === */
    #dpaint-window {
      min-width: 420px;
      min-height: 340px;
    }
    #dpaint-body {
      padding: 0;
      display: flex;
      flex-direction: column;
      height: calc(100% - 22px);
      overflow: hidden;
    }
    #dpaint-layout {
      display: flex;
      flex: 1;
      min-height: 0;
    }
    #dpaint-canvas-wrap {
      flex: 1;
      position: relative;
      background: #555;
      padding: 2px;
      min-width: 0;
      overflow: hidden;
    }
    #dpaint-canvas {
      display: block;
      width: 100%;
      height: 100%;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      background: #a0a0a0;
      cursor: crosshair;
    }
    #dpaint-overlay {
      position: absolute;
      top: 2px;
      left: 2px;
      width: calc(100% - 4px);
      height: calc(100% - 4px);
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      pointer-events: none;
    }
    #dpaint-toolbar {
      width: 38px;
      background: #888;
      border-left: 2px solid #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 3px 2px;
      gap: 2px;
      overflow-y: auto;
      flex-shrink: 0;
    }
    .dp-tool {
      width: 30px;
      height: 26px;
      border: 2px outset #ccc;
      background: #a0a0a0;
      cursor: inherit;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      font-family: 'Silkscreen', monospace;
      font-size: 9px;
      color: #000;
      flex-shrink: 0;
    }
    .dp-tool:hover { background: #c0c0c0; }
    .dp-tool.active {
      border-style: inset;
      background: #6688cc;
      color: #fff;
    }
    .dp-tool svg { width: 18px; height: 18px; }
    .dp-divider {
      width: 26px;
      border: none;
      border-top: 1px solid #555;
      border-bottom: 1px solid #ccc;
      margin: 2px 0;
    }
    #dpaint-palette-bar {
      display: flex;
      align-items: center;
      background: #888;
      border-top: 2px solid #fff;
      padding: 3px 4px;
      gap: 4px;
      flex-shrink: 0;
      height: 34px;
    }
    #dp-color-indicator {
      width: 28px;
      height: 28px;
      position: relative;
      flex-shrink: 0;
      border: 1px solid #000;
    }
    #dp-bg-swatch {
      position: absolute;
      inset: 0;
      background: #a0a0a0;
    }
    #dp-fg-swatch {
      position: absolute;
      top: 4px;
      left: 4px;
      width: 14px;
      height: 14px;
      background: #000;
      border: 1px solid #fff;
    }
    #dp-palette {
      display: flex;
      flex-wrap: wrap;
      gap: 1px;
      flex: 1;
    }
    .dp-color {
      width: 14px;
      height: 12px;
      border: 1px solid #000;
      cursor: inherit;
      flex-shrink: 0;
    }
    .dp-color:hover { border-color: #fff; }
    .dp-color.fg-selected { border: 2px solid #fff; }
    .dp-color.bg-selected { border: 2px dashed #fff; }

    /* Collapsible recommendation windows */
    .rec-window .rec-body {
      display: none;
    }
    .rec-window.open .rec-body {
      display: block;
    }
    .rec-hint {
      margin-left: 8px;
      font-size: 10px;
      color: #ffdd44;
      text-transform: uppercase;
      opacity: 0.85;
      white-space: nowrap;
      display: none;
    }
    .rec-window:not(.open) .rec-hint {
      display: inline;
    }
    .rec-toggle {
      cursor: inherit;
    }
    .rec-toggle:hover {
      background: linear-gradient(to bottom, #7799dd 0%, #5577bb 100%);
    }
    .rec-window .window-title {
      border-bottom: none;
    }
    .rec-window.open .window-title {
      border-bottom: 2px solid #fff;
    }

    /* Draggable windows */
    .window.is-dragging {
      opacity: 0.9;
    }
    .window.is-absolute {
      position: absolute;
    }

    /* Trashcan */
    #trash-icon {
      position: fixed;
      bottom: 12px;
      right: 12px;
      z-index: 5;
    }

    /* Guru Meditation */
    .guru-screen {
      position: fixed;
      inset: 0;
      background: #000;
      z-index: 99999;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: inherit;
    }
    .guru-box {
      border: 4px solid #f00;
      padding: 12px 32px;
      text-align: center;
      animation: guru-flash 1s step-end infinite;
    }
    .guru-box div {
      font-family: 'Silkscreen', 'Courier New', monospace;
      font-size: 16px;
      color: #f00;
      line-height: 1.8;
    }
    @keyframes guru-flash {
      0%, 100% { border-color: #f00; }
      50% { border-color: #000; }
    }

    /* Save button */
    .dp-save {
      background: #4a4;
      color: #fff;
      border: 2px outset #6c6;
    }
    .dp-save:hover { background: #5b5; }
    .dp-save.saving {
      background: #aa8;
      border-style: inset;
      pointer-events: none;
    }
    .dp-save.saved {
      background: #4a4;
      border-style: inset;
    }
    .dp-save.error {
      background: #a44;
      border-style: inset;
    }

    /* Pictures window */
    #pictures-body {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 8px 10px;
      min-height: 60px;
      align-content: flex-start;
    }
    .pic-thumb {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      text-decoration: none;
      color: #aaccff;
      font-size: 9px;
    }
    .pic-thumb img {
      width: 80px;
      height: 64px;
      object-fit: contain;
      image-rendering: pixelated;
      border: 2px solid #fff;
      background: #001a44;
    }
    .pic-thumb:hover img {
      border-color: #ffaa00;
    }
    .pic-empty {
      color: #6699cc;
      font-size: 12px;
      padding: 16px;
    }
    .pic-thumb[draggable="true"] {
      cursor: grab;
    }
    .pic-thumb.dragging {
      opacity: 0.4;
    }

    /* Trashcan drop target */
    #trash-icon.drag-over .icon-box svg rect:first-of-type {
      fill: #c44;
    }
    #trash-icon.drag-over .icon-label {
      color: #ff6644;
    }

    /* Painting viewer window */
    .painting-viewer {
      padding: 4px;
      background: #555;
    }
    .painting-viewer img {
      display: block;
      width: 100%;
      height: auto;
      image-rendering: pixelated;
      border: 2px solid #fff;
    }

    /* Timeline window */
    #timeline-window {
      min-width: 460px;
      min-height: 260px;
    }
    .timeline-body {
      padding: 8px 10px;
      background: #002266;
      color: #aaccff;
      font-size: 12px;
      overflow: auto;
    }
    .timeline-legend {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 8px;
      color: #ffdd44;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .timeline-legend span {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .timeline-swatch {
      width: 10px;
      height: 10px;
      border: 1px solid #fff;
      box-shadow: 1px 1px 0 #000;
    }
    .timeline-grid {
      display: grid;
      gap: 2px;
      background: #001244;
      padding: 6px;
      border: 2px solid #fff;
      box-shadow: 2px 2px 0 #000;
      overflow-x: auto;
    }
    .timeline-label {
      font-size: 10px;
      color: #ffdd44;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }
    .timeline-year {
      font-size: 9px;
      color: #6699cc;
      text-align: center;
      white-space: nowrap;
    }
    .timeline-cell {
      width: 14px;
      height: 14px;
      background: #003366;
      border: 1px solid #001a44;
    }
    .timeline-cell.active-exp {
      background: #ffaa00;
      border-color: #ffdd44;
    }
    .timeline-cell.active-edu {
      background: #66ccff;
      border-color: #aaccff;
    }
    .timeline-cell.multi::after {
      content: '';
      display: block;
      width: 4px;
      height: 4px;
      margin: 4px auto 0;
      background: #ffffff;
    }
    .timeline-detail {
      margin-top: 8px;
      padding: 6px 8px;
      background: #001a44;
      border: 2px solid #fff;
      color: #aaccff;
      min-height: 44px;
      font-size: 11px;
    }

    /* AmigaBASIC window */
    #basic-body {
      background: #0022aa;
      color: #fff;
      font-family: 'Silkscreen', monospace;
      font-size: 13px;
      padding: 0;
      overflow-y: auto;
      cursor: text;
      display: flex;
      flex-direction: column;
      scrollbar-color: #6688cc #4466aa;
    }
    #basic-output {
      white-space: pre-wrap;
      word-break: break-all;
      padding: 6px 8px 0;
      flex: 1;
    }
    #basic-input-line {
      display: flex;
      padding: 0 8px 6px;
    }
    #basic-prompt {
      white-space: pre;
    }
    #basic-input {
      background: transparent;
      border: none;
      color: #fff;
      font-family: 'Silkscreen', monospace;
      font-size: 13px;
      outline: none;
      flex: 1;
      padding: 0;
      caret-color: #ffaa00;
    }

    /* Print CV (hidden on screen) */
    #print-cv {
      display: none;
      font-family: 'Segoe UI', Arial, Helvetica, sans-serif;
      color: #000;
      background: #fff;
      max-width: 700px;
      margin: 0 auto;
      padding: 24px 32px;
      font-size: 11pt;
      line-height: 1.5;
    }
    #print-cv h1 { font-size: 22pt; margin: 0 0 2px; }
    #print-cv .cv-contact { color: #555; font-size: 10pt; margin-bottom: 16px; }
    #print-cv h2 { font-size: 13pt; border-bottom: 1.5px solid #333; padding-bottom: 2px; margin: 14px 0 6px; }
    #print-cv h3 { font-size: 11pt; margin: 6px 0 1px; }
    #print-cv .cv-date { float: right; font-weight: normal; color: #555; }
    #print-cv .cv-role { font-style: italic; margin: 0 0 2px; }
    #print-cv .cv-detail { color: #444; margin: 0 0 2px; font-size: 10pt; }
    #print-cv ul { margin: 4px 0 4px 18px; padding: 0; }
    #print-cv li { margin-bottom: 2px; }
    #print-cv a { color: #0055aa; }

    @media print {
      body * { visibility: hidden !important; }
      #print-cv, #print-cv * { visibility: visible !important; }
      #print-cv {
        display: block !important;
        position: absolute;
        left: 0; top: 0;
        width: 100%;
      }
      body { background: #fff !important; padding: 0 !important; }
    }

    /* Mail window */
    #mail-body {
      padding: 8px 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .mail-field { display: flex; align-items: center; gap: 6px; }
    .mail-field label { width: 60px; flex-shrink: 0; font-size: 12px; color: #aaccff; }
    .mail-field input, .mail-field textarea {
      flex: 1;
      background: #0022aa;
      color: #fff;
      font-family: 'Silkscreen', monospace;
      font-size: 12px;
      border: 2px solid;
      border-color: #000 #aaccff #aaccff #000;
      padding: 3px 6px;
      outline: none;
      caret-color: #ffaa00;
    }
    .mail-field input:read-only { color: #6699cc; }
    .mail-field textarea {
      height: 120px;
      resize: vertical;
    }
    .mail-send {
      align-self: flex-end;
      background: #6688cc;
      color: #ffaa00;
      font-family: 'Silkscreen', monospace;
      font-size: 13px;
      font-weight: 700;
      border: 2px solid;
      border-color: #aaccff #000 #000 #aaccff;
      padding: 4px 16px;
      cursor: inherit;
      margin-top: 4px;
    }
    .mail-send:hover { background: #7799dd; }

    /* Responsive */
    @media (max-width: 600px) {
      body { padding: 2px; font-size: 12px; }
      .window-body { padding: 6px 8px; }
      .icon-row { gap: 16px; }
    }

    /* Touch device enhancements */
    @media (pointer: coarse) {
      .window-title { min-height: 36px; touch-action: none; }
      .window-title .close-gadget { width: 28px; height: 24px; }
      .wb-icon { min-width: 60px; min-height: 60px; }
      .dp-tool { min-width: 36px; min-height: 36px; }
      .dp-color { min-width: 22px; min-height: 22px; }
      #dpaint-canvas, #dpaint-overlay { touch-action: none; }
      #dp-touch-color-toggle {
        display: inline-flex; align-items: center; justify-content: center;
        min-width: 36px; min-height: 36px;
        font-size: 11px; font-weight: bold; letter-spacing: 0.5px;
      }
    }

    @media (pointer: fine) {
      #dp-touch-color-toggle { display: none !important; }
    }
  </style>
</head>
<body>
  <div class="boot-screen" id="boot-screen">
    <div class="boot-box">
      <div class="boot-line">Kickstart ROM v3.1</div>
      <img id="boot-hand" alt="Insert Workbench disk animation" src="/boot-hand.gif">
      <div class="boot-line">Insert Workbench disk</div>
      <div class="boot-line" id="boot-mem">Memory check: <span class="highlight">0 KB</span></div>
      <div class="boot-line" id="boot-scan">Scanning expansion devices...</div>
      <div class="boot-line" id="boot-chipset">Checking chipset: Agnus / Denise / Paula</div>
      <div class="boot-line" id="boot-drives">Mounting DH0: DF0:</div>
      <div class="boot-line" id="boot-load">Loading Workbench...</div>
    </div>
  </div>

  <!-- Screen title bar -->
  <div class="wb-screen-bar">
    <span>Workbench Screen</span>
    <div class="gadgets">
      <div class="gadget"></div>
      <div class="gadget"></div>
    </div>
  </div>

  <!-- Main shell window -->
  <div class="window rec-window open" id="main-window">
    <div class="window-title rec-toggle" data-toggle="main-window">
      <div class="close-gadget" id="main-close"></div>
      <span class="title-text">AmigaShell - Emil Visti</span>
    </div>
    <div class="window-body rec-body" id="terminal"></div>
  </div>

  <!-- Note windows (dynamically populated) -->
  <div id="note-windows" style="display:contents"></div>

  <!-- Demoscene window -->
  <div class="window" id="demo-window">
    <div class="window-title">
      <div class="close-gadget" id="demo-close"></div>
      <span class="title-text">Demoscene - Starfield</span>
    </div>
    <div class="window-body" id="demo-body">
      <canvas id="demo-canvas"></canvas>
      <div id="scroller" aria-hidden="true"></div>
    </div>
  </div>

  <!-- DPaint window (hidden by default) -->
  <div class="window" id="dpaint-window" style="display:none">
    <div class="window-title">
      <div class="close-gadget" id="dpaint-close"></div>
      <span class="title-text">Deluxe Paint - [untitled]</span>
    </div>
    <div class="window-body" id="dpaint-body">
      <div id="dpaint-layout">
        <div id="dpaint-canvas-wrap">
          <canvas id="dpaint-canvas"></canvas>
          <canvas id="dpaint-overlay"></canvas>
        </div>
        <div id="dpaint-toolbar">
          <button class="dp-tool active" data-tool="pencil" title="Pencil (P)">
            <svg viewBox="0 0 18 18"><line x1="4" y1="14" x2="14" y2="4" stroke="#000" stroke-width="2"/><rect x="12" y="2" width="3" height="3" fill="#000"/></svg>
          </button>
          <button class="dp-tool" data-tool="line" title="Line (L)">
            <svg viewBox="0 0 18 18"><line x1="2" y1="16" x2="16" y2="2" stroke="#000" stroke-width="2"/></svg>
          </button>
          <button class="dp-tool" data-tool="rect" title="Rectangle (R)">
            <svg viewBox="0 0 18 18"><rect x="2" y="4" width="14" height="10" fill="none" stroke="#000" stroke-width="2"/></svg>
          </button>
          <button class="dp-tool" data-tool="circle" title="Circle (C)">
            <svg viewBox="0 0 18 18"><ellipse cx="9" cy="9" rx="7" ry="6" fill="none" stroke="#000" stroke-width="2"/></svg>
          </button>
          <button class="dp-tool" data-tool="fill" title="Fill (F)">
            <svg viewBox="0 0 18 18"><path d="M4 14 L4 6 L10 2 L10 6 L14 6 L14 14 Z" fill="#000"/><path d="M15 10 Q17 13 15 15 Q13 13 15 10" fill="#000"/></svg>
          </button>
          <button class="dp-tool" data-tool="eraser" title="Eraser (E)">
            <svg viewBox="0 0 18 18"><rect x="3" y="6" width="12" height="8" rx="1" fill="#fff" stroke="#000" stroke-width="1.5"/><rect x="3" y="10" width="12" height="4" rx="1" fill="#fcc" stroke="#000" stroke-width="1.5"/></svg>
          </button>
          <button class="dp-tool" data-tool="eyedropper" title="Eyedropper (I)">
            <svg viewBox="0 0 18 18"><path d="M6 16 L4 14 L10 8 L12 10 Z" fill="#000"/><circle cx="13" cy="5" r="3" fill="none" stroke="#000" stroke-width="1.5"/></svg>
          </button>
          <hr class="dp-divider">
          <button class="dp-tool" id="dp-filled-toggle" title="Toggle Filled (Shift+F)">
            <svg viewBox="0 0 18 18"><rect x="2" y="4" width="14" height="10" fill="none" stroke="#000" stroke-width="2"/><rect x="5" y="7" width="8" height="4" fill="#000"/></svg>
          </button>
          <hr class="dp-divider">
          <button class="dp-tool dp-size active" data-size="1" title="1px brush">
            <svg viewBox="0 0 18 18"><rect x="8" y="8" width="2" height="2" fill="#000"/></svg>
          </button>
          <button class="dp-tool dp-size" data-size="2" title="2px brush">
            <svg viewBox="0 0 18 18"><rect x="7" y="7" width="4" height="4" fill="#000"/></svg>
          </button>
          <button class="dp-tool dp-size" data-size="3" title="3px brush">
            <svg viewBox="0 0 18 18"><rect x="6" y="6" width="6" height="6" fill="#000"/></svg>
          </button>
          <hr class="dp-divider">
          <button class="dp-tool" id="dp-clear" title="Clear canvas">CLR</button>
          <button class="dp-tool" id="dp-touch-color-toggle" title="Toggle FG/BG draw color">FG</button>
          <hr class="dp-divider">
          <button class="dp-tool dp-save" id="dp-save" title="Save painting (Ctrl+S)">
            <svg viewBox="0 0 18 18"><path d="M3 1h10l3 3v11a2 2 0 01-2 2H3a2 2 0 01-2-2V3a2 2 0 012-2z" fill="none" stroke="#fff" stroke-width="1.5"/><rect x="5" y="1" width="7" height="5" rx="0.5" fill="#fff" opacity="0.7"/><rect x="5" y="10" width="8" height="6" rx="1" fill="#fff" opacity="0.5"/></svg>
          </button>
        </div>
      </div>
      <div id="dpaint-palette-bar">
        <div id="dp-color-indicator">
          <div id="dp-bg-swatch"></div>
          <div id="dp-fg-swatch"></div>
        </div>
        <div id="dp-palette"></div>
      </div>
    </div>
  </div>

  <!-- Pictures window (hidden by default) -->
  <div class="window" id="pictures-window" style="display:none">
    <div class="window-title">
      <div class="close-gadget" id="pictures-close"></div>
      <span class="title-text">Pictures</span>
    </div>
    <div class="window-body" id="pictures-body">
      <div class="pic-empty">No paintings saved yet</div>
    </div>
  </div>

  <!-- AmigaBASIC window (hidden by default) -->
  <div class="window" id="basic-window" style="display:none">
    <div class="window-title">
      <div class="close-gadget" id="basic-close"></div>
      <span class="title-text">AmigaBASIC</span>
    </div>
    <div class="window-body" id="basic-body">
      <div id="basic-output"></div>
      <div id="basic-input-line">
        <span id="basic-prompt"></span>
        <input type="text" id="basic-input" autocomplete="off" spellcheck="false">
      </div>
    </div>
  </div>

  <!-- Mail window (hidden by default) -->
  <div class="window" id="mail-window" style="display:none">
    <div class="window-title">
      <div class="close-gadget" id="mail-close"></div>
      <span class="title-text">Mail - Compose</span>
    </div>
    <div class="window-body" id="mail-body">
      <div class="mail-field">
        <label>To:</label>
        <input type="text" id="mail-to" value="emilvisti@gmail.com" readonly>
      </div>
      <div class="mail-field">
        <label>Subject:</label>
        <input type="text" id="mail-subject" placeholder="Subject..." autocomplete="off">
      </div>
      <div class="mail-field">
        <label>Body:</label>
        <textarea id="mail-msg" placeholder="Write your message..."></textarea>
      </div>
      <button class="mail-send" id="mail-send-btn">Send</button>
    </div>
  </div>

  <!-- Disk pie window (hidden by default) -->
  <div class="window" id="disk-window" style="display:none">
    <div class="window-title">
      <div class="close-gadget" id="disk-close"></div>
      <span class="title-text">Disk Map</span>
    </div>
    <div class="window-body" id="disk-body">
      <canvas id="disk-canvas"></canvas>
    </div>
  </div>

  <!-- File Manager window (hidden by default) -->
  <div class="window" id="filemgr-window" style="display:none">
    <div class="window-title">
      <div class="close-gadget" id="filemgr-close"></div>
      <span class="title-text">File Manager - DH0:</span>
    </div>
    <div class="window-body" id="filemgr-body">
      <div class="fm-pane fm-left">
        <div class="fm-path">DH0:CV/</div>
        <div class="fm-list" id="filemgr-list"></div>
      </div>
      <div class="fm-pane fm-right">
        <div class="fm-title" id="filemgr-title">Defrag View</div>
        <canvas id="filemgr-canvas"></canvas>
      </div>
    </div>
  </div>

  <!-- Timeline window (hidden by default) -->
  <div class="window" id="timeline-window" style="display:none">
    <div class="window-title">
      <div class="close-gadget" id="timeline-close"></div>
      <span class="title-text">Timeline Map</span>
    </div>
    <div class="window-body timeline-body" id="timeline-body">
      <div class="timeline-legend">
        <span><i class="timeline-swatch" style="background:#ffaa00;border-color:#ffdd44"></i>Experience</span>
        <span><i class="timeline-swatch" style="background:#66ccff;border-color:#aaccff"></i>Education</span>
      </div>
      <div class="timeline-grid" id="timeline-grid"></div>
      <div class="timeline-detail" id="timeline-detail">Hover a block to see details.</div>
    </div>
  </div>

  <!-- Icon row at bottom -->
  <div class="icon-row">
    <a class="wb-icon" href="#" id="cv-icon" aria-label="CV">
      <div class="icon-box">
        <svg viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
          <rect x="4" y="2" width="28" height="32" fill="#0055AA" stroke="white" stroke-width="2"/>
          <rect x="8" y="6" width="20" height="4" fill="#ffaa00"/>
          <rect x="8" y="12" width="18" height="2" fill="#fff"/>
          <rect x="8" y="16" width="14" height="2" fill="#fff"/>
          <rect x="8" y="20" width="18" height="2" fill="#fff"/>
          <rect x="8" y="24" width="16" height="2" fill="#fff"/>
          <rect x="8" y="28" width="12" height="2" fill="#fff"/>
        </svg>
      </div>
      <span class="icon-label">CV</span>
    </a>
    <a class="wb-icon" href="https://github.com/visti" target="_blank" rel="noopener noreferrer">
      <div class="icon-box">
        <svg viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
          <path d="M0 0 H30 L34 4 V34 H0 Z" fill="#0055AA" stroke="white" stroke-width="2"/>
          <rect x="6" y="14" width="22" height="16" fill="white"/>
          <rect x="8" y="2" width="14" height="8" fill="white" stroke="black" stroke-width="1"/>
          <rect x="12" y="18" width="14" height="2" fill="#0055AA"/>
          <rect x="12" y="22" width="14" height="2" fill="#0055AA"/>
          <rect x="12" y="26" width="10" height="2" fill="#0055AA"/>
        </svg>
      </div>
      <span class="icon-label">GitHub</span>
    </a>
    <a class="wb-icon" href="https://soundcloud.com/visti-1" target="_blank" rel="noopener noreferrer">
      <div class="icon-box">
        <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
          <rect x="12" y="4" width="2" height="18" fill="white"/>
          <rect x="22" y="2" width="2" height="18" fill="white"/>
          <rect x="12" y="4" width="12" height="2" fill="white"/>
          <rect x="6" y="20" width="8" height="6" rx="3" fill="white"/>
          <rect x="16" y="18" width="8" height="6" rx="3" fill="white"/>
          <rect x="4" y="28" width="24" height="2" fill="#FF8800"/>
          <rect x="2" y="26" width="2" height="4" fill="#FF8800"/>
          <rect x="28" y="26" width="2" height="4" fill="#FF8800"/>
        </svg>
      </div>
      <span class="icon-label">SoundCloud</span>
    </a>
    <a class="wb-icon" href="#" id="reboot-icon" aria-label="Reboot">
      <div class="icon-box">
        <svg viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
          <path d="M0 0 H30 L34 4 V34 H0 Z" fill="#0055AA" stroke="white" stroke-width="2"/>
          <rect x="6" y="14" width="22" height="16" fill="white"/>
          <rect x="8" y="2" width="14" height="8" fill="white" stroke="black" stroke-width="1"/>
          <path d="M10 22 L15 27 L24 16" stroke="#FF8800" stroke-width="3" fill="none"/>
        </svg>
      </div>
      <span class="icon-label">Reboot</span>
    </a>
    <a class="wb-icon" href="#" id="demo-icon" aria-label="Demoscene">
      <div class="icon-box">
        <svg viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
          <path d="M0 0 H30 L34 4 V34 H0 Z" fill="#0055AA" stroke="white" stroke-width="2"/>
          <rect x="6" y="14" width="22" height="16" fill="#111"/>
          <circle cx="10" cy="20" r="1.5" fill="#fff"/>
          <circle cx="22" cy="17" r="1" fill="#ffaa00"/>
          <circle cx="15" cy="25" r="1" fill="#66ccff"/>
          <circle cx="26" cy="23" r="1.5" fill="#fff"/>
          <circle cx="18" cy="18" r="0.8" fill="#ff8800"/>
          <circle cx="12" cy="27" r="0.8" fill="#fff"/>
          <circle cx="24" cy="28" r="1" fill="#ffaa00"/>
        </svg>
      </div>
      <span class="icon-label">Demo<br>Scene</span>
    </a>
    <a class="wb-icon" href="#" id="dpaint-icon" aria-label="Deluxe Paint">
      <div class="icon-box">
        <svg viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
          <path d="M0 0 H30 L34 4 V34 H0 Z" fill="#0055AA" stroke="white" stroke-width="2"/>
          <rect x="6" y="14" width="22" height="16" fill="white"/>
          <circle cx="11" cy="22" r="3" fill="#ec0000"/>
          <circle cx="19" cy="22" r="3" fill="#fcec00"/>
          <circle cx="15" cy="27" r="3" fill="#0000fc"/>
          <rect x="19" y="2" width="3" height="10" fill="#ffaa00" transform="rotate(-20 20.5 7)"/>
          <rect x="18" y="1" width="5" height="3" fill="#642000" transform="rotate(-20 20.5 2.5)"/>
        </svg>
      </div>
      <span class="icon-label">Deluxe<br>Paint</span>
    </a>
    <a class="wb-icon" href="#" id="filemgr-icon" aria-label="File Manager">
      <div class="icon-box">
        <svg viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
          <rect x="2" y="6" width="32" height="24" fill="#0055AA" stroke="white" stroke-width="2"/>
          <rect x="4" y="8" width="28" height="6" fill="#ffaa00"/>
          <rect x="6" y="16" width="12" height="4" fill="#66ccff"/>
          <rect x="6" y="22" width="18" height="4" fill="#66ccff"/>
        </svg>
      </div>
      <span class="icon-label">File<br>Manager</span>
    </a>
    <a class="wb-icon" href="#" id="pictures-icon" aria-label="Pictures">
      <div class="icon-box">
        <svg viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
          <path d="M0 0 H30 L34 4 V34 H0 Z" fill="#0055AA" stroke="white" stroke-width="2"/>
          <rect x="6" y="14" width="22" height="16" fill="white"/>
          <rect x="8" y="2" width="14" height="8" fill="white" stroke="black" stroke-width="1"/>
          <circle cx="13" cy="21" r="2" fill="#ffaa00"/>
          <path d="M8 28 L14 22 L18 26 L22 20 L28 28 Z" fill="#4a8"/>
        </svg>
      </div>
      <span class="icon-label">Pictures</span>
    </a>
    <a class="wb-icon" href="#" id="basic-icon" aria-label="AmigaBASIC">
      <div class="icon-box">
        <svg viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
          <path d="M0 0 H30 L34 4 V34 H0 Z" fill="#0055AA" stroke="white" stroke-width="2"/>
          <rect x="6" y="14" width="22" height="16" fill="#0022aa"/>
          <rect x="8" y="2" width="14" height="8" fill="white" stroke="black" stroke-width="1"/>
          <rect x="8" y="16" width="4" height="2" fill="#ffaa00"/>
          <rect x="14" y="16" width="10" height="2" fill="white"/>
          <rect x="8" y="20" width="4" height="2" fill="#ffaa00"/>
          <rect x="14" y="20" width="8" height="2" fill="white"/>
          <rect x="8" y="24" width="4" height="2" fill="#ffaa00"/>
          <rect x="14" y="24" width="6" height="2" fill="white"/>
        </svg>
      </div>
      <span class="icon-label">Amiga<br>BASIC</span>
    </a>
    <a class="wb-icon" href="#" id="mail-icon" aria-label="Mail">
      <div class="icon-box">
        <svg viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
          <path d="M0 0 H30 L34 4 V34 H0 Z" fill="#0055AA" stroke="white" stroke-width="2"/>
          <rect x="6" y="14" width="22" height="16" fill="white"/>
          <rect x="8" y="2" width="14" height="8" fill="white" stroke="black" stroke-width="1"/>
          <rect x="6" y="14" width="22" height="14" fill="#ffffcc" stroke="#888" stroke-width="1"/>
          <path d="M6 14 L17 23 L28 14" fill="none" stroke="#0055AA" stroke-width="2"/>
          <path d="M6 28 L14 22" fill="none" stroke="#0055AA" stroke-width="1"/>
          <path d="M28 28 L20 22" fill="none" stroke="#0055AA" stroke-width="1"/>
        </svg>
      </div>
      <span class="icon-label">Mail</span>
    </a>
    <a class="wb-icon" href="#" id="timeline-icon" aria-label="Timeline">
      <div class="icon-box">
        <svg viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
          <rect x="2" y="4" width="32" height="28" fill="#0055AA" stroke="white" stroke-width="2"/>
          <rect x="6" y="8" width="6" height="6" fill="#ffaa00"/>
          <rect x="14" y="8" width="6" height="6" fill="#66ccff"/>
          <rect x="22" y="8" width="6" height="6" fill="#ffaa00"/>
          <rect x="6" y="16" width="6" height="6" fill="#66ccff"/>
          <rect x="14" y="16" width="6" height="6" fill="#ffaa00"/>
          <rect x="22" y="16" width="6" height="6" fill="#66ccff"/>
          <rect x="6" y="24" width="6" height="6" fill="#ffaa00"/>
          <rect x="14" y="24" width="6" height="6" fill="#66ccff"/>
          <rect x="22" y="24" width="6" height="6" fill="#ffaa00"/>
        </svg>
      </div>
      <span class="icon-label">Timeline</span>
    </a>
    <a class="wb-icon" href="#" id="print-icon" aria-label="Print CV">
      <div class="icon-box">
        <svg viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
          <path d="M0 0 H30 L34 4 V34 H0 Z" fill="#0055AA" stroke="white" stroke-width="2"/>
          <rect x="6" y="14" width="22" height="16" fill="white"/>
          <rect x="8" y="2" width="14" height="8" fill="white" stroke="black" stroke-width="1"/>
          <rect x="4" y="16" width="26" height="12" fill="#ccc" stroke="#666" stroke-width="1"/>
          <rect x="8" y="10" width="18" height="8" fill="#fff" stroke="#888" stroke-width="1"/>
          <rect x="8" y="26" width="18" height="8" fill="#fff" stroke="#888" stroke-width="1"/>
          <rect x="10" y="28" width="12" height="2" fill="#0055AA"/>
          <rect x="10" y="31" width="8" height="2" fill="#0055AA"/>
          <rect x="22" y="20" width="4" height="2" fill="#4a4" rx="1"/>
        </svg>
      </div>
      <span class="icon-label">Print CV</span>
    </a>
    <div id="note-icons" style="display:contents"></div>
  </div>

  <!-- Trashcan (lower-right, like real Workbench) -->
  <a class="wb-icon" id="trash-icon" href="#">
    <div class="icon-box">
      <svg viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
        <rect x="6" y="8" width="24" height="24" fill="#888" stroke="white" stroke-width="2"/>
        <rect x="10" y="4" width="16" height="6" fill="#aaa" stroke="white" stroke-width="2"/>
        <rect x="14" y="2" width="8" height="4" fill="#aaa" stroke="white" stroke-width="2"/>
        <rect x="10" y="14" width="2" height="14" fill="#555"/>
        <rect x="17" y="14" width="2" height="14" fill="#555"/>
        <rect x="24" y="14" width="2" height="14" fill="#555"/>
      </svg>
    </div>
    <span class="icon-label">Trashcan</span>
  </a>

  <!-- Print-only CV (hidden on screen, shown in print) -->
  <div id="print-cv">
    <h1>Emil Visti</h1>
    <div class="cv-contact">Copenhagen &middot; emilvisti@gmail.com &middot; <a href="https://github.com/visti">github.com/visti</a></div>

    <h2>Experience</h2>

    <h3>Data Specialist <span class="cv-date">2017 &ndash; present</span></h3>
    <p class="cv-role">Gramex, Copenhagen</p>
    <p class="cv-detail">SQL / Python / Excel / Access / Navision / SSMS</p>
    <p class="cv-detail">Processing 350k+ plays/month for royalty payouts to artists and labels across Denmark</p>
    <p class="cv-detail">Reports for public display, legal &amp; internal use</p>
    <p class="cv-detail">PowerBI / Matplotlib / Pandas / Python automation</p>

    <h3>Metadata Expert <span class="cv-date">2014 &ndash; 2016</span></h3>
    <p class="cv-role">Sandrew Metronome, Aalborg</p>

    <h3>Asst. Producer &mdash; Video / Music / Graphics <span class="cv-date">2012 &ndash; 2014</span></h3>
    <p class="cv-role">Big Beard Productions, Aalborg</p>

    <h3>Writer &mdash; SEO, Articles, Podcasts <span class="cv-date">2012 &ndash; 2015</span></h3>
    <p class="cv-role">Rotation.dk</p>

    <h3>PR Associate <span class="cv-date">2011 &ndash; 2012</span></h3>
    <p class="cv-role">ORA (Org. af Rytmiske Amat&oslash;rmusikere)</p>

    <h2>Education</h2>

    <h3>Librarian DB <span class="cv-date">2014 &ndash; 2015</span></h3>
    <p class="cv-role">IVA Aalborg</p>

    <h3>BSc Information Science <span class="cv-date">2008 &ndash; 2014</span></h3>
    <p class="cv-role">IVA Aalborg</p>

    <h3>Gymnasium <span class="cv-date">2003 &ndash; 2006</span></h3>
    <p class="cv-role">Dronninglund</p>

    <h2>Skills</h2>
    <ul>
      <li>SQL, Python, Bash, Lua, GDScript</li>
      <li>SSMS, Access, Navision, Excel, PowerBI</li>
      <li>Pandas, Matplotlib, data visualization</li>
      <li>Unix &amp; Windows sysadmin</li>
      <li>Photoshop, Premiere, Ableton</li>
      <li>Metadata standards &amp; digitization</li>
      <li>Studio technician (music)</li>
    </ul>

    <h2>Languages</h2>
    <p>Danish, English</p>

    <h2>Links</h2>
    <p><a href="https://github.com/visti">github.com/visti</a> &middot; <a href="https://soundcloud.com/visti-1">soundcloud.com/visti-1</a></p>
  </div>

  <script>
    const GITHUB_USER = 'visti';

    const fallback = {
      name: 'Emil Visti',
      location: 'Copenhagen',
      company: 'Gramex',
      public_repos: 14,
      followers: 0,
      following: 1,
      created_at: '2013-03-08T00:00:00Z'
    };

    const fallbackRepos = [
      { name: 'Sandrew', language: 'Python', stargazers_count: 1, fork: false, description: 'File handling & processing scripts' },
      { name: 'Tv2Formatter', language: 'Python', stargazers_count: 0, fork: false, description: 'CLI tool for TV2 XML files' },
      { name: 'CommercialFormatter', language: 'Python', stargazers_count: 0, fork: false, description: 'Porting file processing to Odin' },
      { name: 'ClaudeProjects', language: null, stargazers_count: 0, fork: false, description: 'Projects developed with Claude AI' },
      { name: 'Norns-Looper', language: 'Lua', stargazers_count: 0, fork: false, description: 'Norns music looper' },
      { name: 'detectivestory', language: 'GDScript', stargazers_count: 0, fork: false, description: 'Detective story game' },
      { name: 'Pico-8_Projects', language: 'Lua', stargazers_count: 0, fork: false, description: 'Pico-8 projects' },
      { name: 'danish_word_of_the_day', language: 'Python', stargazers_count: 0, fork: false, description: 'E-ink danish word display' },
      { name: 'gamejam', language: 'Python', stargazers_count: 0, fork: false, description: 'Game jam project' },
      { name: 'visti.github.io', language: 'HTML', stargazers_count: 0, fork: false, description: 'Personal site' },
    ];

    async function fetchGitHub() {
      try {
        const [userRes, reposRes, commitsRes] = await Promise.all([
          fetch(`https://api.github.com/users/${GITHUB_USER}`),
          fetch(`https://api.github.com/users/${GITHUB_USER}/repos?sort=updated&per_page=100`),
          fetch(`https://api.github.com/search/commits?q=author:${GITHUB_USER}`, {
            headers: { 'Accept': 'application/vnd.github.cloak-preview+json' }
          })
        ]);
        if (!userRes.ok || !reposRes.ok) throw new Error('API error');
        const user = await userRes.json();
        const repos = await reposRes.json();
        const commits = commitsRes.ok ? await commitsRes.json() : null;
        user.total_commits = commits ? commits.total_count : null;
        return { user, repos };
      } catch {
        return { user: fallback, repos: fallbackRepos };
      }
    }

    function pad(str, len) { return String(str).padEnd(len); }

    function makeBar(count, max) {
      const width = Math.max(1, Math.round((count / max) * 16));
      return '\u2588'.repeat(width);
    }

    function buildLines(user, repos) {
      const hideRepos = ['claudeprojects', 'detectivestory', 'gamejam', 'visti.github.io'];
      const ownRepos = repos.filter(r => !r.fork && !hideRepos.includes(r.name.toLowerCase()));
      const year = new Date(user.created_at).getFullYear();

      const langCount = {};
      ownRepos.forEach(r => {
        if (r.language) langCount[r.language] = (langCount[r.language] || 0) + 1;
      });
      const langSorted = Object.entries(langCount).sort((a, b) => b[1] - a[1]);
      const maxLang = langSorted.length ? langSorted[0][1] : 1;

      const lines = [];

      // Boot
      lines.push({ type: 'boot', html: '<span class="dim-text">Amiga Kickstart ROM v3.1</span>' });
      lines.push({ type: 'boot', html: '<span class="dim-text">68030 CPU @ 25MHz  -  2MB Chip RAM  -  8MB Fast RAM</span>' });
      lines.push({ type: 'boot', html: '<span class="dim-text">Loading Workbench...</span>' });
      lines.push({ type: 'blank' });

      // Prompt: whoami
      const parts = [user.name, user.location, user.company].filter(Boolean);
      lines.push({ type: 'cmd', html: `<span class="prompt-text">1.SYS:&gt;</span> <span class="cmd-text">whoami</span>` });
      lines.push({ type: 'out', html: `<span class="output-text">${parts.join(' - ')}</span>` });
      lines.push({ type: 'blank' });

      // GitHub stats
      lines.push({ type: 'cmd', html: `<span class="prompt-text">1.SYS:&gt;</span> <span class="cmd-text">type DH0:github_stats</span>` });
      lines.push({ type: 'out', html: `<span class="output-text">  Username:     <span class="highlight">${GITHUB_USER}</span></span>` });
      lines.push({ type: 'out', html: `<span class="output-text">  Repos:        <span class="highlight">${user.public_repos}</span></span>` });
      lines.push({ type: 'out', html: `<span class="output-text">  Commits:      <span class="highlight">${user.total_commits != null ? user.total_commits : '...'}</span></span>` });
      lines.push({ type: 'out', html: `<span class="output-text">  Member since: <span class="highlight">${year}</span></span>` });
      lines.push({ type: 'blank' });

      // Experience
      lines.push({ type: 'cmd', html: `<span class="prompt-text">1.SYS:&gt;</span> <span class="cmd-text">type DH0:experience.log</span>` });
      lines.push({ type: 'out', html: `<span class="highlight">  Gramex, Copenhagen ......................... 2017-now</span>` });
      lines.push({ type: 'out', html: `<span class="output-text">  Data Specialist</span>` });
      lines.push({ type: 'out', html: `<span class="dim-text">  SQL / Python / Excel / Access / Navision / SSMS</span>` });
      lines.push({ type: 'out', html: `<span class="dim-text">  Processing 350k+ plays/month for royalty payouts</span>` });
      lines.push({ type: 'out', html: `<span class="dim-text">  to artists and labels across Denmark</span>` });
      lines.push({ type: 'out', html: `<span class="dim-text">  Reports for public display, legal & internal use</span>` });
      lines.push({ type: 'out', html: `<span class="dim-text">  PowerBI / Matplotlib / Pandas / Python automation</span>` });
      lines.push({ type: 'blank' });
      lines.push({ type: 'out', html: `<span class="highlight">  Sandrew Metronome, Aalborg ................. 2014-2016</span>` });
      lines.push({ type: 'out', html: `<span class="output-text">  Metadata Expert</span>` });
      lines.push({ type: 'blank' });
      lines.push({ type: 'out', html: `<span class="highlight">  Big Beard Productions, Aalborg ............. 2012-2014</span>` });
      lines.push({ type: 'out', html: `<span class="output-text">  Asst. Producer - Video/Music/Graphics</span>` });
      lines.push({ type: 'blank' });
      lines.push({ type: 'out', html: `<span class="highlight">  Rotation.dk ................................ 2012-2015</span>` });
      lines.push({ type: 'out', html: `<span class="output-text">  Writer - SEO, Articles, Podcasts</span>` });
      lines.push({ type: 'blank' });
      lines.push({ type: 'out', html: `<span class="highlight">  ORA (Org. af Rytmiske Amatormusikere) ...... 2011-2012</span>` });
      lines.push({ type: 'out', html: `<span class="output-text">  PR Associate</span>` });
      lines.push({ type: 'blank' });

      // Education
      lines.push({ type: 'cmd', html: `<span class="prompt-text">1.SYS:&gt;</span> <span class="cmd-text">type DH0:education</span>` });
      lines.push({ type: 'out', html: '<span class="output-text">  Librarian DB (IVA Aalborg) ............. 2014-2015</span>' });
      lines.push({ type: 'out', html: '<span class="output-text">  BSc Information Science (IVA Aalborg) .. 2008-2014</span>' });
      lines.push({ type: 'out', html: '<span class="output-text">  Gymnasium (Dronninglund) .............. 2003-2006</span>' });
      lines.push({ type: 'blank' });

      // Skills
      lines.push({ type: 'cmd', html: `<span class="prompt-text">1.SYS:&gt;</span> <span class="cmd-text">type DH0:skills.cfg</span>` });
      lines.push({ type: 'out', html: '<span class="output-text">  SQL / Python / Bash / Lua / GDScript</span>' });
      lines.push({ type: 'out', html: '<span class="output-text">  SSMS / Access / Navision / Excel / PowerBI</span>' });
      lines.push({ type: 'out', html: '<span class="output-text">  Pandas / Matplotlib / data visualization</span>' });
      lines.push({ type: 'out', html: '<span class="output-text">  Unix & Windows sysadmin</span>' });
      lines.push({ type: 'out', html: '<span class="output-text">  Photoshop / Premiere / Ableton</span>' });
      lines.push({ type: 'out', html: '<span class="output-text">  Metadata standards & digitization</span>' });
      lines.push({ type: 'out', html: '<span class="output-text">  Studio technician (music)</span>' });
      lines.push({ type: 'out', html: '<span class="dim-text">  Languages: Danish, English</span>' });
      lines.push({ type: 'blank' });

      // Projects
      lines.push({ type: 'cmd', html: `<span class="prompt-text">1.SYS:&gt;</span> <span class="cmd-text">list DH0:projects/</span>` });
      ownRepos.forEach(r => {
        const name = pad(r.name, 24);
        const lang = r.language ? `<span class="highlight">${pad(r.language, 10)}</span>` : pad('-', 10);
        const star = r.stargazers_count > 0 ? `<span class="star-text">\u2605 ${r.stargazers_count}</span>  ` : '     ';
        const desc = r.description || '';
        lines.push({ type: 'out', html: `<span class="output-text">  ${name}${lang}${star}<span class="dim-text">${desc}</span></span>` });
      });
      lines.push({ type: 'blank' });

      // Languages
      lines.push({ type: 'cmd', html: `<span class="prompt-text">1.SYS:&gt;</span> <span class="cmd-text">type DH0:languages.dat</span>` });
      langSorted.forEach(([lang, count]) => {
        const label = pad(lang, 12);
        const bar = makeBar(count, maxLang);
        const num = count === 1 ? '1 repo' : `${count} repos`;
        lines.push({ type: 'out', html: `<span class="output-text">  ${label}<span class="bar-text">${bar}</span> ${num}</span>` });
      });
      lines.push({ type: 'blank' });

      // Links
      lines.push({ type: 'cmd', html: `<span class="prompt-text">1.SYS:&gt;</span> <span class="cmd-text">type DH0:links</span>` });
      lines.push({ type: 'out', html: `  <a href="https://github.com/${GITHUB_USER}" target="_blank" rel="noopener noreferrer">github.com/${GITHUB_USER}</a>` });
      lines.push({ type: 'blank' });

      // Final prompt
      lines.push({ type: 'final' });

      return lines;
    }

    async function fetchNotes() {
      try {
        const res = await fetch('./notes/manifest.json');
        if (!res.ok) throw new Error('manifest fetch failed');
        const filenames = await res.json();
        const notes = await Promise.all(filenames.map(async (name, index) => {
          const r = await fetch('./notes/' + name);
          if (!r.ok) return null;
          const md = await r.text();
          return parseNote(md, index);
        }));
        return notes.filter(Boolean);
      } catch {
        return [];
      }
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function safeUrl(url) {
      const raw = String(url || '').trim();
      const lower = raw.toLowerCase();
      if (!raw) return '#';
      if (lower.startsWith('javascript:') || lower.startsWith('data:') || lower.startsWith('vbscript:')) return '#';
      if (
        lower.startsWith('http://') ||
        lower.startsWith('https://') ||
        lower.startsWith('mailto:') ||
        lower.startsWith('./') ||
        lower.startsWith('../') ||
        lower.startsWith('/') ||
        lower.startsWith('#')
      ) {
        return raw;
      }
      return '#';
    }

    function safeId(str) {
      const cleaned = String(str || '').toLowerCase().replace(/[^a-z0-9_-]/g, '_');
      return cleaned || 'file';
    }

    function parseNote(md, index) {
      const text = md.replace(/\r\n/g, '\n');
      const fmMatch = text.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)$/);
      if (!fmMatch) return null;
      const fmBlock = fmMatch[1];
      const body = fmMatch[2].trim();

      const meta = {};
      fmBlock.split('\n').forEach(line => {
        const m = line.match(/^(\w+):\s*(.+)$/);
        if (!m) return;
        let val = m[2].trim();
        if (val.startsWith('"') && val.endsWith('"')) val = val.slice(1, -1);
        if (val === 'true') val = true;
        else if (val === 'false') val = false;
        meta[m[1]] = val;
      });

      const bodyHtml = body.split('\n').map(line => {
        if (line.trim() === '') return '<br>';
        // Process inline markdown
        let html = escapeHtml(line)
          .replace(/\*\*(.+?)\*\*/g, '<span class="highlight">$1</span>')
          .replace(/\[([^\]]+)\]\(([^)]+)\)/g, (m, text, url) => {
            return '<a href="' + escapeHtml(safeUrl(url)) + '" target="_blank" rel="noopener noreferrer">' + text + '</a>';
          });
        if (line.startsWith('> ')) {
          html = '<div class="dim-text">' + html.slice(4) + '</div>';
        } else {
          html = '<div class="output-text">' + html + '</div>';
        }
        return html;
      }).join('\n');

      return {
        title: meta.title || 'Note',
        filename: meta.filename || '',
        icon: (meta.icon || 'Note').replace(/\\n/g, '\n'),
        open: meta.open === true,
        bodyHtml,
        id: 'note-' + index
      };
    }

    function renderNotes(notes) {
      const container = document.getElementById('note-windows');
      const iconContainer = document.getElementById('note-icons');
      if (!container || !iconContainer) return;

      const docSvg = `<svg viewBox="0 0 30 36" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
        <path d="M2 0 H22 L28 6 V34 H2 Z" fill="white" stroke="#0055AA" stroke-width="2"/>
        <path d="M22 0 V6 H28" fill="none" stroke="#0055AA" stroke-width="2"/>
        <rect x="6" y="10" width="18" height="2" fill="#0055AA"/>
        <rect x="6" y="15" width="18" height="2" fill="#0055AA"/>
        <rect x="6" y="20" width="18" height="2" fill="#0055AA"/>
        <rect x="6" y="25" width="12" height="2" fill="#0055AA"/>
      </svg>`;

      notes.forEach(note => {
        // Create window
        const win = document.createElement('div');
        win.className = 'window rec-window' + (note.open ? ' open' : '');
        win.id = note.id;
        if (!note.open) win.style.display = 'none';

        const safeTitle = escapeHtml(note.title);
        const safeFilename = escapeHtml(note.filename);
        const safeIcon = escapeHtml(note.icon);
        win.innerHTML =
          `<div class="window-title rec-toggle" data-toggle="${note.id}">` +
            `<div class="close-gadget note-close"></div>` +
            `<span class="title-text">${safeTitle}</span>` +
            `<span class="rec-hint">click to expand</span>` +
          `</div>` +
          `<div class="window-body rec-body">` +
            `<div class="dim-text">${safeFilename}</div><br>` +
            note.bodyHtml +
          `</div>`;

        container.appendChild(win);

        // Close gadget hides the window
        win.querySelector('.note-close').addEventListener('click', (e) => {
          e.stopPropagation();
          win.style.display = 'none';
        });

        // Create icon
        const icon = document.createElement('a');
        icon.className = 'wb-icon';
        icon.id = note.id + '-icon';
        icon.href = '#';
        icon.innerHTML =
          `<div class="icon-box">${docSvg}</div>` +
          `<span class="icon-label">${safeIcon}</span>`;

        icon.addEventListener('click', (e) => {
          e.preventDefault();
          if (win.style.display === 'none') {
            win.style.display = '';
            if (!win.classList.contains('is-absolute')) {
              mobileWindowPos(win, 380, null);
            }
            win.classList.add('open');
            bringToFront(win);
          } else {
            win.style.display = 'none';
          }
        });

        iconContainer.appendChild(icon);
      });
    }

    async function main() {
      const terminal = document.getElementById('terminal');
      const [{ user, repos }, notes] = await Promise.all([fetchGitHub(), fetchNotes()]);
      const lines = buildLines(user, repos);

      const elements = lines.map(line => {
        const div = document.createElement('div');
        div.classList.add('line');

        if (line.type === 'blank') {
          div.innerHTML = '&nbsp;';
        } else if (line.type === 'final') {
          div.innerHTML = `<span class="prompt-text">1.SYS:&gt;</span> <span class="cursor"></span>`;
        } else {
          div.innerHTML = line.html;
        }

        terminal.appendChild(div);
        return { el: div, line };
      });

      renderNotes(notes);
      applyInitialLayout();
      applyNoteLayout(notes);
      if (document.documentElement.clientWidth < 600) {
        document.getElementById('demo-window').style.display = 'none';
        const mw = document.getElementById('main-window');
        if (mw) mw.style.height = Math.round(document.documentElement.clientHeight * 0.7) + 'px';
      }
      sizeWindowsToContent();
      sizeMainWindowBody();
      sizeDemoCanvas();
      startStarfield();
      startScroller();

      return function startTypewriter() {
        let i = 0;
        function showNext() {
          if (i >= elements.length) return;
          const { el, line } = elements[i];
          el.classList.add('visible');
          i++;

          const delays = {
            'boot': 120,
            'cmd': 200,
            'blank': 50,
            'out': 35,
            'final': 0,
          };
          const delay = delays[line.type] ?? 40;
          if (line.type !== 'final') {
            setTimeout(showNext, delay);
          }
        }
        setTimeout(showNext, 300);
      };
    }

    // Hidden message for fellow devs
    const easterEgg = String.raw`
 ____________________________________________________
|                                                    |
|     ___          _  __   _   ___  __  ___          |
|    | __|_ __ _ _| | \\ \\ / (_)__| _||_(  )         |
|    | _|| '  \\ | | |  \\ V /| (_-<  | _/ |          |
|    |___|_|_|_|___|_|   \\_/ |_/__/  |_| _|          |
|                                                    |
|     |
|     This site was built with love & nostalgia     |
|     on a rainy day in Copenhagen.                 |
|                                                   |
|     Stack: HTML + inline CSS/JS + GitHub API      |
|     Host:  Fly.io (node:20-alpine)                 |
|     Aesthetic: Amiga Workbench 3.1                |
|                                                   |
|     > github.com/visti                            |
|     > soundcloud.com/visti-1                      |
|     |
|                                                    |
|   "Computers in the future may weigh no more       |
|    than 1.5 tons."  Popular Mechanics, 1949       |
|____________________________________________________|`;
    console.log(
      `%c${easterEgg}`,
      'color: #ffaa00; font-family: monospace; font-size: 12px; background: #0055aa; padding: 8px;'
    );

    async function runBootSequence() {
      const screen = document.getElementById('boot-screen');
      const mem = document.getElementById('boot-mem');
      const scan = document.getElementById('boot-scan');
      const chipset = document.getElementById('boot-chipset');
      const drives = document.getElementById('boot-drives');
      const load = document.getElementById('boot-load');
      if (!screen || !mem || !scan || !chipset || !drives || !load) return;
      screen.classList.add('active');
      load.style.visibility = 'hidden';
      scan.style.visibility = 'hidden';
      chipset.style.visibility = 'hidden';
      drives.style.visibility = 'hidden';

      let kb = 0;
      const maxKb = 8192;
      const step = 256;
      while (kb <= maxKb) {
        mem.innerHTML = `Memory check: <span class="highlight">${kb} KB</span>`;
        await new Promise(r => setTimeout(r, 40));
        kb += step;
      }
      scan.style.visibility = 'visible';
      await new Promise(r => setTimeout(r, 260));
      chipset.style.visibility = 'visible';
      await new Promise(r => setTimeout(r, 260));
      drives.style.visibility = 'visible';
      await new Promise(r => setTimeout(r, 300));
      load.style.visibility = 'visible';
      await new Promise(r => setTimeout(r, 900));

      screen.classList.remove('active');
    }

    (async () => {
      const [, startTypewriter] = await Promise.all([
        runBootSequence(),
        main()
      ]);
      if (startTypewriter) startTypewriter();
    })();

    const reboot = document.getElementById('reboot-icon');
    if (reboot) {
      reboot.addEventListener('click', async (e) => {
        e.preventDefault();
        await runBootSequence();
      });
    }

    function guruMeditation() {
      const guru = document.createElement('div');
      guru.className = 'guru-screen';
      guru.innerHTML =
        '<div class="guru-box">' +
          '<div>Software Failure.  Press left mouse button to continue.</div>' +
          '<div>Guru Meditation #00000004.0000AAC0</div>' +
        '</div>';
      document.body.appendChild(guru);
      guru.addEventListener('click', () => guru.remove());
    }

    const trash = document.getElementById('trash-icon');
    if (trash) {
      trash.addEventListener('click', (e) => {
        e.preventDefault();
        guruMeditation();
      });
    }

    function toggleRec(id) {
      const win = document.getElementById(id);
      if (!win) return;
      const title = win.querySelector('.window-title');
      const wasOpen = win.classList.contains('open');
      if (title && wasOpen) {
        // Capture height BEFORE removing .open (which hides .rec-body)
        const prev = win.style.height || win.getBoundingClientRect().height + 'px';
        win.dataset.prevHeight = prev;
        win.classList.remove('open');
        win.style.height = (title.offsetHeight + 4) + 'px';
      } else if (title && !wasOpen) {
        win.classList.add('open');
        if (win.dataset.prevHeight) {
          win.style.height = win.dataset.prevHeight;
          delete win.dataset.prevHeight;
        } else {
          win.style.height = '';
        }
      } else {
        win.classList.toggle('open');
      }
      sizeWindowsToContent();
      sizeMainWindowBody();
    }

    function sizeWindowsToContent() {
      const wins = document.querySelectorAll('.window');
      const viewportMax = document.documentElement.clientWidth - 8;
      wins.forEach((win) => {
      if (win.id === 'demo-window' || win.id === 'dpaint-window' || win.id === 'mail-window' || win.id === 'disk-window' || win.id === 'filemgr-window') return;
        if (win.style.width) return; // already sized, don't ratchet
        const title = win.querySelector('.window-title');
        const body = win.querySelector('.window-body');
        let w = 0;
        if (title) w = Math.max(w, title.scrollWidth);
        if (body) w = Math.max(w, body.scrollWidth);
        w += 8;
        const target = Math.min(w, viewportMax);
        win.style.width = target + 'px';
      });
    }

    function applyInitialLayout() {
      const vw = document.documentElement.clientWidth;
      const vh = document.documentElement.clientHeight;
      if (vw < 900 || vh < 700) return;

      const starts = {
        'main-window': { x: 40, y: 120, w: 560, h: Math.round(vh * 0.625) },
        'demo-window': { x: Math.max(40, vw - 520), y: 120, w: 480, h: 260 },
        'disk-window': { x: Math.max(40, vw - 520), y: 420, w: 420, h: 300 },
        'filemgr-window': { x: Math.max(40, vw - 640), y: 140, w: 600, h: 340 },
      };

      Object.entries(starts).forEach(([id, pos]) => {
        const win = document.getElementById(id);
        if (!win) return;
        win.classList.add('is-absolute');
        win.style.left = Math.min(pos.x, vw - 260) + 'px';
        win.style.top = Math.min(pos.y, vh - 140) + 'px';
        win.style.width = Math.min(pos.w, vw - 16) + 'px';
        if (pos.h) {
          win.style.height = Math.min(pos.h, vh - 40) + 'px';
        }
      });
    }

    function applyNoteLayout(notes) {
      const vw = document.documentElement.clientWidth;
      const vh = document.documentElement.clientHeight;
      if (vw < 900 || vh < 700) return;

      notes.forEach((note, i) => {
        if (!note.open) return;
        const win = document.getElementById(note.id);
        if (!win) return;
        win.classList.add('is-absolute');
        win.style.left = Math.min(760, vw - 260) + 'px';
        win.style.top = Math.min(330 + i * 210, vh - 140) + 'px';
        win.style.width = Math.min(360, vw - 16) + 'px';
      });
    }

    function sizeMainWindowBody() {
      const win = document.getElementById('main-window');
      if (!win) return;
      const title = win.querySelector('.window-title');
      const body = win.querySelector('.window-body');
      if (!title || !body) return;
      const inner = win.clientHeight - title.offsetHeight - 4;
      body.style.height = Math.max(inner, 140) + 'px';
    }

    function sizeDemoCanvas() {
      const win = document.getElementById('demo-window');
      const body = document.getElementById('demo-body');
      const canvas = document.getElementById('demo-canvas');
      const scroller = document.getElementById('scroller');
      if (!win || !body || !canvas) return;
      const title = win.querySelector('.window-title');
      const inner = win.clientHeight - (title ? title.offsetHeight : 0) - 12;
      body.style.height = Math.max(inner, 120) + 'px';
      const rect = body.getBoundingClientRect();
      const w = Math.max(120, Math.floor(rect.width - 12));
      const h = Math.max(90, Math.floor(rect.height - 12));
      if (canvas.width !== w || canvas.height !== h) {
        canvas.width = w;
        canvas.height = h;
      }
      if (scroller) {
        const pad = 2;
        scroller.style.left = (canvas.offsetLeft + pad) + 'px';
        scroller.style.top = (canvas.offsetTop + pad) + 'px';
        scroller.style.width = Math.max(0, canvas.clientWidth - pad * 2) + 'px';
        scroller.style.height = Math.max(0, canvas.clientHeight - pad * 2) + 'px';
      }
    }

    function sizeDiskCanvas() {
      const win = document.getElementById('disk-window');
      const body = document.getElementById('disk-body');
      const canvas = document.getElementById('disk-canvas');
      if (!win || !body || !canvas || win.style.display === 'none') return;
      const title = win.querySelector('.window-title');
      const inner = win.clientHeight - (title ? title.offsetHeight : 0) - 12;
      body.style.height = Math.max(inner, 160) + 'px';
      const rect = body.getBoundingClientRect();
      const w = Math.max(160, Math.floor(rect.width - 12));
      const h = Math.max(160, Math.floor(rect.height - 12));
      if (canvas.width !== w || canvas.height !== h) {
        canvas.width = w;
        canvas.height = h;
      }
    }

    function sizeFileMgrCanvas() {
      const win = document.getElementById('filemgr-window');
      const canvas = document.getElementById('filemgr-canvas');
      const body = document.getElementById('filemgr-body');
      if (!win || !canvas || !body || win.style.display === 'none') return;
      const title = win.querySelector('.window-title');
      const inner = win.clientHeight - (title ? title.offsetHeight : 0) - 12;
      body.style.height = Math.max(inner, 200) + 'px';
      const rect = canvas.getBoundingClientRect();
      const w = Math.max(200, Math.floor(rect.width));
      const h = Math.max(180, Math.floor(rect.height));
      if (canvas.width !== w || canvas.height !== h) {
        canvas.width = w;
        canvas.height = h;
      }
    }

    function startStarfield() {
      const canvas = document.getElementById('demo-canvas');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      if (!ctx) return;
      const stars = Array.from({ length: 140 }, () => ({
        x: Math.random() * 2 - 1,
        y: Math.random() * 2 - 1,
        z: Math.random(),
        v: 0.004 + Math.random() * 0.012
      }));

      function render() {
        sizeDemoCanvas();
        const w = canvas.width;
        const h = canvas.height;
        ctx.fillStyle = '#001a44';
        ctx.fillRect(0, 0, w, h);

        const cx = w / 2;
        const cy = h / 2;
        const scale = Math.min(w, h) * 0.6;
        for (const s of stars) {
          s.z -= s.v;
          if (s.z <= 0.02) {
            s.x = Math.random() * 2 - 1;
            s.y = Math.random() * 2 - 1;
            s.z = 1;
            s.v = 0.004 + Math.random() * 0.012;
          }
          const x = cx + (s.x / s.z) * scale;
          const y = cy + (s.y / s.z) * scale;
          if (x < 0 || x > w || y < 0 || y > h) continue;
          const size = Math.max(1, Math.floor((1 - s.z) * 2.5));
          const shade = Math.floor(160 + (1 - s.z) * 95);
          ctx.fillStyle = `rgb(${shade}, ${shade}, ${shade})`;
          ctx.fillRect(x, y, size, size);
        }
        requestAnimationFrame(render);
      }

      requestAnimationFrame(render);
    }

    // === Disk pie animation ===
    const diskSlices = [
      { value: 38, color: '#ffaa00' },
      { value: 22, color: '#66ccff' },
      { value: 16, color: '#ff6699' },
      { value: 12, color: '#66ff66' },
      { value: 7, color: '#ffcc33' },
      { value: 5, color: '#cc66ff' }
    ];
    let diskAnim = { running: false, start: 0, duration: 1100 };

    const defragSets = {
      disk: {
        title: 'Disk (DH0:)',
        base: '#ffaa00',
        slices: diskSlices
      },
      experience: {
        title: 'Experience',
        base: '#ffcc33',
        slices: [
          { value: 40, color: '#ffaa00', label: 'Gramex' },
          { value: 25, color: '#ff9933', label: 'Sandrew' },
          { value: 20, color: '#ff6633', label: 'Big Beard' },
          { value: 10, color: '#ff3366', label: 'Rotation' },
          { value: 5, color: '#ffdd44', label: 'ORA' }
        ]
      },
      education: {
        title: 'Education',
        base: '#66ccff',
        slices: [
          { value: 50, color: '#66ccff', label: 'BSc' },
          { value: 25, color: '#33aaff', label: 'Librarian' },
          { value: 25, color: '#99ddff', label: 'Gymnasium' }
        ]
      },
      skills: {
        title: 'Skills',
        base: '#66ff66',
        slices: [
          { value: 30, color: '#66ff66', label: 'Data' },
          { value: 25, color: '#aaff66', label: 'Tools' },
          { value: 20, color: '#33cc66', label: 'Systems' },
          { value: 15, color: '#88ff88', label: 'Creative' },
          { value: 10, color: '#44aa44', label: 'Other' }
        ]
      },
      languages: {
        title: 'Languages',
        base: '#cc66ff',
        slices: [
          { value: 55, color: '#cc66ff', label: 'Danish' },
          { value: 45, color: '#9966ff', label: 'English' }
        ]
      },
      links: {
        title: 'Links',
        base: '#66ffff',
        slices: [
          { value: 60, color: '#66ffff', label: 'GitHub' },
          { value: 40, color: '#33ccff', label: 'SoundCloud' }
        ]
      },
      recommendations: {
        title: 'Recommendations',
        base: '#ff6699',
        slices: [
          { value: 40, color: '#ff6699', label: 'Gramex' },
          { value: 30, color: '#ff99bb', label: 'Sandrew' },
          { value: 30, color: '#ff3366', label: 'ORA' }
        ]
      }
    };

    const fileMgrItems = [
      { id: 'experience', label: 'Experience' },
      { id: 'education', label: 'Education' },
      { id: 'skills', label: 'Skills' },
      { id: 'languages', label: 'Languages' },
      { id: 'recommendations', label: 'Recommendations' }
    ];

    function allocateBlocks(values, totalBlocks) {
      const sum = values.reduce((a, b) => a + b, 0) || 1;
      const raw = values.map(v => (v / sum) * totalBlocks);
      const blocks = raw.map(v => Math.max(1, Math.floor(v)));
      let used = blocks.reduce((a, b) => a + b, 0);
      while (used < totalBlocks) {
        let best = 0;
        let bestFrac = -1;
        raw.forEach((v, i) => {
          const frac = v - Math.floor(v);
          if (frac > bestFrac) { bestFrac = frac; best = i; }
        });
        blocks[best] += 1;
        used += 1;
      }
      while (used > totalBlocks) {
        let idx = blocks.findIndex(b => b > 1);
        if (idx === -1) break;
        blocks[idx] -= 1;
        used -= 1;
      }
      return blocks;
    }

    function drawDefragGrid(canvasId, t, slices) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      if (!ctx) return;
      const w = canvas.width;
      const h = canvas.height;

      ctx.clearRect(0, 0, w, h);
      ctx.fillStyle = '#001244';
      ctx.fillRect(0, 0, w, h);

      const labelW = 80;
      const gridW = Math.max(120, w - labelW - 12);
      const cell = Math.max(8, Math.min(12, Math.floor(gridW / 24)));
      const cols = Math.max(16, Math.floor(gridW / cell));
      const gap = 2;
      const rows = slices.length;
      const totalBlocks = cols;
      const blocks = allocateBlocks(slices.map(s => s.value), totalBlocks);

      const rowH = cell + 6;
      const startY = Math.max(8, Math.floor((h - rows * rowH) / 2));

      ctx.font = '10px Silkscreen, monospace';
      ctx.textBaseline = 'middle';
      ctx.textAlign = 'left';

      slices.forEach((s, row) => {
        const y = startY + row * rowH;
        ctx.fillStyle = '#ffdd44';
        ctx.fillText(s.label || '', 6, y + cell / 2);

        const rowProgress = Math.min(1, Math.max(0, (t - row * 0.08) / 0.7));
        const fillCount = Math.floor(blocks[row] * rowProgress);
        for (let i = 0; i < cols; i++) {
          const x = labelW + i * cell;
          ctx.fillStyle = '#003366';
          ctx.fillRect(x, y, cell - gap, cell - gap);
          if (i < fillCount) {
            ctx.fillStyle = s.color;
            ctx.fillRect(x, y, cell - gap, cell - gap);
          }
        }
      });
    }

    function drawDefrag(id) {
      const set = defragSets[id] || defragSets.experience;
      const title = document.getElementById('filemgr-title');
      if (title) title.textContent = `Defrag View  ${set.title}`;
      let t = 0;
      const start = performance.now();
      const duration = 900;
      const step = (now) => {
        t = Math.min(1, (now - start) / duration);
        drawDefragGrid('filemgr-canvas', t, set.slices);
        if (t < 1) requestAnimationFrame(step);
      };
      requestAnimationFrame(step);
    }

    function drawPie(canvasId, t, slices, baseColor, showLabels) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      if (!ctx) return;
      const w = canvas.width;
      const h = canvas.height;
      const cx = w / 2;
      const cy = h / 2;
      const r = Math.min(w, h) * 0.38;

      ctx.clearRect(0, 0, w, h);
      ctx.fillStyle = '#001244';
      ctx.fillRect(0, 0, w, h);

      // Base solid disk (fade out as slices expand)
      const baseAlpha = Math.max(0, 1 - t * 1.2);
      if (baseAlpha > 0) {
        ctx.globalAlpha = baseAlpha;
        ctx.fillStyle = baseColor || '#ffaa00';
        ctx.beginPath();
        ctx.arc(cx, cy, r, 0, Math.PI * 2);
        ctx.fill();
        ctx.globalAlpha = 1;
      }

      const total = slices.reduce((s, a) => s + a.value, 0);
      let start = -Math.PI / 2;
      slices.forEach((s) => {
        const fullSweep = (s.value / total) * Math.PI * 2;
        const sweep = fullSweep * t;
        if (sweep <= 0.001) return;
        ctx.fillStyle = s.color;
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.arc(cx, cy, r, start, start + sweep);
        ctx.closePath();
        ctx.fill();
        if (showLabels && t > 0.9 && s.label && fullSweep > 0.25) {
          const mid = start + fullSweep / 2;
          const lr = r * 0.68;
          const lx = cx + Math.cos(mid) * lr;
          const ly = cy + Math.sin(mid) * lr;
          ctx.fillStyle = '#ffffff';
          ctx.font = '10px Silkscreen, monospace';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(s.label, lx, ly);
        }
        start += fullSweep;
      });

      // Center hub
      ctx.fillStyle = '#003366';
      ctx.beginPath();
      ctx.arc(cx, cy, r * 0.12, 0, Math.PI * 2);
      ctx.fill();
    }

    function animateDiskPie() {
      if (diskAnim.running) return;
      diskAnim.running = true;
      diskAnim.start = performance.now();

      const step = (now) => {
        const t = Math.min(1, (now - diskAnim.start) / diskAnim.duration);
        drawPie('disk-canvas', t, diskSlices, '#ffaa00', false);
        if (t < 1 && diskAnim.running) {
          requestAnimationFrame(step);
        } else {
          diskAnim.running = false;
        }
      };
      requestAnimationFrame(step);
    }

    function startScroller() {
      const text = 'Emil Visti curriculum vitae 2026  ';
      const scroller = document.getElementById('scroller');
      if (!scroller) return;
      scroller.innerHTML = '';
      const inner = document.createElement('div');
      inner.style.whiteSpace = 'nowrap';
      inner.style.display = 'inline-block';
      scroller.appendChild(inner);

      function addText() {
        return text.split('').map((ch) => {
          const span = document.createElement('span');
          span.textContent = ch === ' ' ? '\u00A0' : ch;
          inner.appendChild(span);
          return span;
        });
      }

      const chars = addText().concat(addText());
      const palette = [
        '#ffcc33', '#ff9933', '#ff6633', '#ff3333',
        '#ff33aa', '#ff66ff', '#cc66ff', '#9966ff',
        '#6699ff', '#33ccff', '#33ffcc', '#66ff66',
        '#ccff66', '#ffff66', '#ffcc33', '#ff9933'
      ];
      let t = 0;
      let offset = 0;

      function render() {
        const canvas = document.getElementById('demo-canvas');
        if (!canvas) return;
        const speed = 1.6;
        const loopWidth = inner.scrollWidth / 2 || 1;
        offset = (offset - speed) % loopWidth;
        const fontSize = parseFloat(getComputedStyle(scroller).fontSize) || 0;
        const baseY = (canvas.clientHeight * 0.5) - (fontSize * 0.5);
        chars.forEach((span, i) => {
          const wave = Math.sin((i * 0.32) + t) * 56;
          span.style.color = palette[(i + Math.floor(t * 12)) % palette.length];
          span.style.transform = `translate(${offset}px, ${wave + baseY}px)`;
        });
        t += 0.08;
        requestAnimationFrame(render);
      }

      requestAnimationFrame(render);
    }

    // --- Touch support ---
    const isTouchDevice = 'ontouchstart' in window;
    function touchXY(e) {
      const t = e.touches[0] || e.changedTouches[0];
      return { clientX: t.clientX, clientY: t.clientY };
    }

    function mobileWindowPos(win, desiredW, desiredH) {
      const vw = document.documentElement.clientWidth;
      const vh = document.documentElement.clientHeight;
      win.classList.add('is-absolute');
      if (vw < 600) {
        win.style.left = '4px';
        win.style.top = '32px';
        win.style.width = (vw - 8) + 'px';
        if (desiredH) win.style.height = Math.min(desiredH, vh - 40) + 'px';
      } else {
        win.style.left = Math.max(20, Math.round((vw - desiredW) / 2)) + 'px';
        win.style.top = Math.max(40, Math.round((vh - (desiredH || 300)) / 2)) + 'px';
        win.style.width = desiredW + 'px';
        if (desiredH) win.style.height = desiredH + 'px';
      }
    }

    // --- Draggable windows ---
    let dragState = null;
    let topZ = 10;

    function bringToFront(win) {
      topZ++;
      win.style.zIndex = topZ;
    }

    document.addEventListener('mousedown', (e) => {
      if (e.target.closest('.close-gadget')) return;
      const titleBar = e.target.closest('.window-title');
      if (!titleBar) {
        // Click on window body still brings to front
        const win = e.target.closest('.window');
        if (win) bringToFront(win);
        return;
      }
      const win = titleBar.closest('.window');
      if (!win) return;

      bringToFront(win);
      const rect = win.getBoundingClientRect();

      dragState = {
        win,
        titleBar,
        startX: e.clientX,
        startY: e.clientY,
        origLeft: rect.left,
        origTop: rect.top + window.scrollY,
        origWidth: rect.width,
        offsetX: e.clientX - rect.left,
        offsetY: e.clientY - rect.top,
        moved: false
      };
      e.preventDefault();
    });

    document.addEventListener('mousemove', (e) => {
      if (!dragState) return;
      const dx = e.clientX - dragState.startX;
      const dy = e.clientY - dragState.startY;

      if (!dragState.moved && (Math.abs(dx) > 3 || Math.abs(dy) > 3)) {
        dragState.moved = true;
        const w = dragState.win;
        if (!w.classList.contains('is-absolute')) {
          w.classList.add('is-absolute');
          w.style.left = dragState.origLeft + 'px';
          w.style.top = dragState.origTop + 'px';
          w.style.width = dragState.origWidth + 'px';
        }
        w.classList.add('is-dragging');
      }

      if (dragState.moved) {
        dragState.win.style.left = (e.clientX - dragState.offsetX) + 'px';
        dragState.win.style.top = (e.clientY - dragState.offsetY + window.scrollY) + 'px';
      }
    });

    document.addEventListener('mouseup', (e) => {
      if (!dragState) return;
      dragState.win.classList.remove('is-dragging');

      if (!dragState.moved) {
        // Was a click, not a drag  toggle collapse
        const toggle = dragState.titleBar.closest('.rec-toggle');
        if (toggle) {
          const id = toggle.dataset.toggle;
          if (id) toggleRec(id);
        }
      }
      dragState = null;
    });

    // --- Window dragging: touch events ---
    document.addEventListener('touchstart', (e) => {
      if (e.target.closest('.close-gadget')) return;
      const titleBar = e.target.closest('.window-title');
      if (!titleBar) {
        const win = e.target.closest('.window');
        if (win) bringToFront(win);
        return;
      }
      const win = titleBar.closest('.window');
      if (!win) return;
      bringToFront(win);
      const pt = touchXY(e);
      const rect = win.getBoundingClientRect();
      dragState = {
        win,
        titleBar,
        startX: pt.clientX,
        startY: pt.clientY,
        origLeft: rect.left,
        origTop: rect.top + window.scrollY,
        origWidth: rect.width,
        offsetX: pt.clientX - rect.left,
        offsetY: pt.clientY - rect.top,
        moved: false
      };
      e.preventDefault();
    }, { passive: false });

    document.addEventListener('touchmove', (e) => {
      if (!dragState) return;
      const pt = touchXY(e);
      const dx = pt.clientX - dragState.startX;
      const dy = pt.clientY - dragState.startY;
      if (!dragState.moved && (Math.abs(dx) > 3 || Math.abs(dy) > 3)) {
        dragState.moved = true;
        const w = dragState.win;
        if (!w.classList.contains('is-absolute')) {
          w.classList.add('is-absolute');
          w.style.left = dragState.origLeft + 'px';
          w.style.top = dragState.origTop + 'px';
          w.style.width = dragState.origWidth + 'px';
        }
        w.classList.add('is-dragging');
      }
      if (dragState.moved) {
        dragState.win.style.left = (pt.clientX - dragState.offsetX) + 'px';
        dragState.win.style.top = (pt.clientY - dragState.offsetY + window.scrollY) + 'px';
        e.preventDefault();
      }
    }, { passive: false });

    document.addEventListener('touchend', (e) => {
      if (!dragState) return;
      dragState.win.classList.remove('is-dragging');
      if (!dragState.moved) {
        const toggle = dragState.titleBar.closest('.rec-toggle');
        if (toggle) {
          const id = toggle.dataset.toggle;
          if (id) toggleRec(id);
        }
      }
      dragState = null;
    });

    window.addEventListener('resize', sizeWindowsToContent);
    window.addEventListener('resize', sizeMainWindowBody);
    window.addEventListener('resize', sizeDemoCanvas);
    window.addEventListener('resize', sizeDiskCanvas);
    window.addEventListener('resize', sizeFileMgrCanvas);

    const mainWin = document.getElementById('main-window');
    if (mainWin && 'ResizeObserver' in window) {
      const ro = new ResizeObserver(() => sizeMainWindowBody());
      ro.observe(mainWin);
    }

    const demoWin = document.getElementById('demo-window');
    if (demoWin && 'ResizeObserver' in window) {
      const ro2 = new ResizeObserver(() => sizeDemoCanvas());
      ro2.observe(demoWin);
    }

    const diskWin = document.getElementById('disk-window');
    if (diskWin && 'ResizeObserver' in window) {
      const roDisk = new ResizeObserver(() => sizeDiskCanvas());
      roDisk.observe(diskWin);
    }

    const fileMgrWin = document.getElementById('filemgr-window');
    if (fileMgrWin && 'ResizeObserver' in window) {
      const roFm = new ResizeObserver(() => sizeFileMgrCanvas());
      roFm.observe(fileMgrWin);
    }

    // === Deluxe Paint ===
    const dpaint = {
      currentTool: 'pencil',
      brushSize: 1,
      filled: false,
      fgColor: '#000000',
      bgColor: '#a0a0a0',
      isDrawing: false,
      startX: 0, startY: 0,
      lastX: 0, lastY: 0,
      canvas: null, ctx: null,
      overlay: null, octx: null,
      canvasW: 320, canvasH: 256,
      touchUseBg: false,
      drawingIsRight: false,
      palette: [
        '#000000','#a0a0a0','#ec0000','#a80000',
        '#dc8800','#fcec00','#88fc00','#008800',
        '#00b864','#00dcdc','#00a8fc','#0074cc',
        '#0000fc','#7400fc','#cc00ec','#cc0088',
        '#642000','#ec5420','#a85420','#fccca8',
        '#303030','#444444','#545454','#646464',
        '#747474','#888888','#989898','#a8a8a8',
        '#cccccc','#dcdcdc','#ececec','#fcfcfc'
      ]
    };

    function initDPaint() {
      const canvas = document.getElementById('dpaint-canvas');
      const overlay = document.getElementById('dpaint-overlay');
      if (!canvas || !overlay) return;
      dpaint.canvas = canvas;
      dpaint.ctx = canvas.getContext('2d');
      dpaint.overlay = overlay;
      dpaint.octx = overlay.getContext('2d');
      canvas.width = dpaint.canvasW;
      canvas.height = dpaint.canvasH;
      overlay.width = dpaint.canvasW;
      overlay.height = dpaint.canvasH;
      dpaint.ctx.fillStyle = dpaint.bgColor;
      dpaint.ctx.fillRect(0, 0, dpaint.canvasW, dpaint.canvasH);

      buildDPaintPalette();
      attachDPaintCanvasEvents();
      attachDPaintToolbarEvents();
    }

    function dpaintCoords(e) {
      const rect = dpaint.canvas.getBoundingClientRect();
      const scaleX = dpaint.canvasW / rect.width;
      const scaleY = dpaint.canvasH / rect.height;
      return {
        x: Math.floor((e.clientX - rect.left) * scaleX),
        y: Math.floor((e.clientY - rect.top) * scaleY)
      };
    }

    function dpaintDrawPixel(x, y, color) {
      const ctx = dpaint.ctx;
      ctx.fillStyle = color;
      const s = dpaint.brushSize;
      const off = Math.floor(s / 2);
      ctx.fillRect(x - off, y - off, s, s);
    }

    function dpaintBresenham(x0, y0, x1, y1, color) {
      const dx = Math.abs(x1 - x0);
      const dy = Math.abs(y1 - y0);
      const sx = x0 < x1 ? 1 : -1;
      const sy = y0 < y1 ? 1 : -1;
      let err = dx - dy;
      while (true) {
        dpaintDrawPixel(x0, y0, color);
        if (x0 === x1 && y0 === y1) break;
        const e2 = 2 * err;
        if (e2 > -dy) { err -= dy; x0 += sx; }
        if (e2 < dx) { err += dx; y0 += sy; }
      }
    }

    function dpaintPreviewShape(x0, y0, x1, y1, color) {
      const octx = dpaint.octx;
      octx.clearRect(0, 0, dpaint.canvasW, dpaint.canvasH);
      octx.strokeStyle = color;
      octx.fillStyle = color;
      octx.lineWidth = dpaint.brushSize;
      if (dpaint.currentTool === 'line') {
        octx.beginPath();
        octx.moveTo(x0 + 0.5, y0 + 0.5);
        octx.lineTo(x1 + 0.5, y1 + 0.5);
        octx.stroke();
      } else if (dpaint.currentTool === 'rect') {
        const rx = Math.min(x0, x1), ry = Math.min(y0, y1);
        const rw = Math.abs(x1 - x0), rh = Math.abs(y1 - y0);
        if (dpaint.filled) {
          octx.fillRect(rx, ry, rw, rh);
        } else {
          octx.strokeRect(rx + 0.5, ry + 0.5, rw, rh);
        }
      } else if (dpaint.currentTool === 'circle') {
        const cx = (x0 + x1) / 2, cy = (y0 + y1) / 2;
        const rx = Math.abs(x1 - x0) / 2, ry = Math.abs(y1 - y0) / 2;
        if (rx < 1 && ry < 1) return;
        octx.beginPath();
        octx.ellipse(cx, cy, Math.max(rx, 1), Math.max(ry, 1), 0, 0, Math.PI * 2);
        if (dpaint.filled) octx.fill();
        else octx.stroke();
      }
    }

    function dpaintCommitShape(x0, y0, x1, y1, color) {
      const ctx = dpaint.ctx;
      ctx.strokeStyle = color;
      ctx.fillStyle = color;
      ctx.lineWidth = dpaint.brushSize;
      if (dpaint.currentTool === 'line') {
        ctx.beginPath();
        ctx.moveTo(x0 + 0.5, y0 + 0.5);
        ctx.lineTo(x1 + 0.5, y1 + 0.5);
        ctx.stroke();
      } else if (dpaint.currentTool === 'rect') {
        const rx = Math.min(x0, x1), ry = Math.min(y0, y1);
        const rw = Math.abs(x1 - x0), rh = Math.abs(y1 - y0);
        if (dpaint.filled) {
          ctx.fillRect(rx, ry, rw, rh);
        } else {
          ctx.strokeRect(rx + 0.5, ry + 0.5, rw, rh);
        }
      } else if (dpaint.currentTool === 'circle') {
        const cx = (x0 + x1) / 2, cy = (y0 + y1) / 2;
        const rx = Math.abs(x1 - x0) / 2, ry = Math.abs(y1 - y0) / 2;
        if (rx < 1 && ry < 1) return;
        ctx.beginPath();
        ctx.ellipse(cx, cy, Math.max(rx, 1), Math.max(ry, 1), 0, 0, Math.PI * 2);
        if (dpaint.filled) ctx.fill();
        else ctx.stroke();
      }
    }

    function hexToRGBA(hex) {
      return {
        r: parseInt(hex.slice(1, 3), 16),
        g: parseInt(hex.slice(3, 5), 16),
        b: parseInt(hex.slice(5, 7), 16),
        a: 255
      };
    }

    function dpaintFloodFill(sx, sy, fillColor) {
      const ctx = dpaint.ctx;
      const w = dpaint.canvasW, h = dpaint.canvasH;
      const imageData = ctx.getImageData(0, 0, w, h);
      const data = imageData.data;
      const idx = (sy * w + sx) * 4;
      const tR = data[idx], tG = data[idx + 1], tB = data[idx + 2], tA = data[idx + 3];
      const fill = hexToRGBA(fillColor);
      if (tR === fill.r && tG === fill.g && tB === fill.b && tA === fill.a) return;
      const stack = [sx, sy];
      const visited = new Uint8Array(w * h);
      while (stack.length > 0) {
        const y = stack.pop(), x = stack.pop();
        if (x < 0 || x >= w || y < 0 || y >= h) continue;
        const pos = y * w + x;
        if (visited[pos]) continue;
        const i = pos * 4;
        if (data[i] !== tR || data[i + 1] !== tG || data[i + 2] !== tB || data[i + 3] !== tA) continue;
        visited[pos] = 1;
        data[i] = fill.r; data[i + 1] = fill.g; data[i + 2] = fill.b; data[i + 3] = fill.a;
        stack.push(x + 1, y, x - 1, y, x, y + 1, x, y - 1);
      }
      ctx.putImageData(imageData, 0, 0);
    }

    function dpaintPickColor(x, y, isRight) {
      const pixel = dpaint.ctx.getImageData(x, y, 1, 1).data;
      const hex = '#' + [pixel[0], pixel[1], pixel[2]].map(v => v.toString(16).padStart(2, '0')).join('');
      if (isRight) {
        dpaint.bgColor = hex;
        document.getElementById('dp-bg-swatch').style.background = hex;
      } else {
        dpaint.fgColor = hex;
        document.getElementById('dp-fg-swatch').style.background = hex;
      }
      updateDPaintPaletteSelection();
    }

    function attachDPaintCanvasEvents() {
      const canvas = dpaint.canvas;
      const win = canvas.closest('.window');

      canvas.addEventListener('mousedown', (e) => {
        e.stopPropagation();
        bringToFront(win);
        const pos = dpaintCoords(e);
        const isRight = e.button === 2;
        const color = isRight ? dpaint.bgColor : dpaint.fgColor;
        dpaint.isDrawing = true;
        dpaint.startX = pos.x; dpaint.startY = pos.y;
        dpaint.lastX = pos.x; dpaint.lastY = pos.y;

        if (dpaint.currentTool === 'pencil') {
          dpaintDrawPixel(pos.x, pos.y, color);
        } else if (dpaint.currentTool === 'eraser') {
          dpaintDrawPixel(pos.x, pos.y, dpaint.bgColor);
        } else if (dpaint.currentTool === 'eyedropper') {
          dpaintPickColor(pos.x, pos.y, isRight);
          dpaint.isDrawing = false;
        } else if (dpaint.currentTool === 'fill') {
          dpaintFloodFill(pos.x, pos.y, color);
          dpaint.isDrawing = false;
        }
      });

      canvas.addEventListener('contextmenu', (e) => e.preventDefault());

      document.addEventListener('mousemove', (e) => {
        if (!dpaint.isDrawing) return;
        const pos = dpaintCoords(e);
        const color = e.buttons === 2 ? dpaint.bgColor : dpaint.fgColor;
        if (dpaint.currentTool === 'pencil') {
          dpaintBresenham(dpaint.lastX, dpaint.lastY, pos.x, pos.y, color);
          dpaint.lastX = pos.x; dpaint.lastY = pos.y;
        } else if (dpaint.currentTool === 'eraser') {
          dpaintBresenham(dpaint.lastX, dpaint.lastY, pos.x, pos.y, dpaint.bgColor);
          dpaint.lastX = pos.x; dpaint.lastY = pos.y;
        } else if (dpaint.currentTool === 'line' || dpaint.currentTool === 'rect' || dpaint.currentTool === 'circle') {
          dpaintPreviewShape(dpaint.startX, dpaint.startY, pos.x, pos.y, color);
        }
      });

      document.addEventListener('mouseup', (e) => {
        if (!dpaint.isDrawing) return;
        const pos = dpaintCoords(e);
        const color = e.button === 2 ? dpaint.bgColor : dpaint.fgColor;
        if (dpaint.currentTool === 'line' || dpaint.currentTool === 'rect' || dpaint.currentTool === 'circle') {
          dpaintCommitShape(dpaint.startX, dpaint.startY, pos.x, pos.y, color);
        }
        dpaint.octx.clearRect(0, 0, dpaint.canvasW, dpaint.canvasH);
        dpaint.isDrawing = false;
      });

      // --- DPaint canvas: touch events ---
      canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        e.stopPropagation();
        bringToFront(win);
        const pt = touchXY(e);
        const pos = dpaintCoords(pt);
        const isRight = dpaint.touchUseBg;
        dpaint.drawingIsRight = isRight;
        const color = isRight ? dpaint.bgColor : dpaint.fgColor;
        dpaint.isDrawing = true;
        dpaint.startX = pos.x; dpaint.startY = pos.y;
        dpaint.lastX = pos.x; dpaint.lastY = pos.y;
        if (dpaint.currentTool === 'pencil') {
          dpaintDrawPixel(pos.x, pos.y, color);
        } else if (dpaint.currentTool === 'eraser') {
          dpaintDrawPixel(pos.x, pos.y, dpaint.bgColor);
        } else if (dpaint.currentTool === 'eyedropper') {
          dpaintPickColor(pos.x, pos.y, isRight);
          dpaint.isDrawing = false;
        } else if (dpaint.currentTool === 'fill') {
          dpaintFloodFill(pos.x, pos.y, color);
          dpaint.isDrawing = false;
        }
      }, { passive: false });

      document.addEventListener('touchmove', (e) => {
        if (!dpaint.isDrawing) return;
        const pt = touchXY(e);
        const pos = dpaintCoords(pt);
        const color = dpaint.drawingIsRight ? dpaint.bgColor : dpaint.fgColor;
        if (dpaint.currentTool === 'pencil') {
          dpaintBresenham(dpaint.lastX, dpaint.lastY, pos.x, pos.y, color);
          dpaint.lastX = pos.x; dpaint.lastY = pos.y;
        } else if (dpaint.currentTool === 'eraser') {
          dpaintBresenham(dpaint.lastX, dpaint.lastY, pos.x, pos.y, dpaint.bgColor);
          dpaint.lastX = pos.x; dpaint.lastY = pos.y;
        } else if (dpaint.currentTool === 'line' || dpaint.currentTool === 'rect' || dpaint.currentTool === 'circle') {
          dpaintPreviewShape(dpaint.startX, dpaint.startY, pos.x, pos.y, color);
        }
        e.preventDefault();
      }, { passive: false });

      document.addEventListener('touchend', (e) => {
        if (!dpaint.isDrawing) return;
        const pt = touchXY(e);
        const pos = dpaintCoords(pt);
        const color = dpaint.drawingIsRight ? dpaint.bgColor : dpaint.fgColor;
        if (dpaint.currentTool === 'line' || dpaint.currentTool === 'rect' || dpaint.currentTool === 'circle') {
          dpaintCommitShape(dpaint.startX, dpaint.startY, pos.x, pos.y, color);
        }
        dpaint.octx.clearRect(0, 0, dpaint.canvasW, dpaint.canvasH);
        dpaint.isDrawing = false;
      });
    }

    function buildDPaintPalette() {
      const container = document.getElementById('dp-palette');
      if (!container) return;
      dpaint.palette.forEach((color) => {
        const cell = document.createElement('div');
        cell.className = 'dp-color';
        cell.style.background = color;
        cell.dataset.color = color;
        cell.addEventListener('mousedown', (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (e.button === 2) {
            dpaint.bgColor = color;
            document.getElementById('dp-bg-swatch').style.background = color;
          } else {
            dpaint.fgColor = color;
            document.getElementById('dp-fg-swatch').style.background = color;
          }
          updateDPaintPaletteSelection();
        });
        cell.addEventListener('contextmenu', (e) => e.preventDefault());
        cell.addEventListener('touchstart', (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (dpaint.touchUseBg) {
            dpaint.bgColor = color;
            document.getElementById('dp-bg-swatch').style.background = color;
          } else {
            dpaint.fgColor = color;
            document.getElementById('dp-fg-swatch').style.background = color;
          }
          updateDPaintPaletteSelection();
        }, { passive: false });
        container.appendChild(cell);
      });
      updateDPaintPaletteSelection();
    }

    function updateDPaintPaletteSelection() {
      document.querySelectorAll('.dp-color').forEach(cell => {
        cell.classList.toggle('fg-selected', cell.dataset.color === dpaint.fgColor);
        cell.classList.toggle('bg-selected', cell.dataset.color === dpaint.bgColor);
      });
    }

    function attachDPaintToolbarEvents() {
      document.querySelectorAll('#dpaint-toolbar .dp-tool[data-tool]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          document.querySelectorAll('#dpaint-toolbar .dp-tool[data-tool]').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          dpaint.currentTool = btn.dataset.tool;
        });
      });
      document.querySelectorAll('#dpaint-toolbar .dp-size').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          document.querySelectorAll('.dp-size').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          dpaint.brushSize = parseInt(btn.dataset.size, 10);
        });
      });
      const filledBtn = document.getElementById('dp-filled-toggle');
      if (filledBtn) {
        filledBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          dpaint.filled = !dpaint.filled;
          filledBtn.classList.toggle('active', dpaint.filled);
        });
      }
      const clearBtn = document.getElementById('dp-clear');
      if (clearBtn) {
        clearBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          dpaint.ctx.fillStyle = dpaint.bgColor;
          dpaint.ctx.fillRect(0, 0, dpaint.canvasW, dpaint.canvasH);
        });
      }
      const colorToggle = document.getElementById('dp-touch-color-toggle');
      if (colorToggle) {
        colorToggle.addEventListener('click', (e) => {
          e.stopPropagation();
          dpaint.touchUseBg = !dpaint.touchUseBg;
          colorToggle.textContent = dpaint.touchUseBg ? 'BG' : 'FG';
        });
      }
    }

    function sizeDPaintCanvas() {
      const win = document.getElementById('dpaint-window');
      const body = document.getElementById('dpaint-body');
      if (!win || !body || win.style.display === 'none') return;
      const title = win.querySelector('.window-title');
      const innerH = win.clientHeight - (title ? title.offsetHeight : 0) - 4;
      body.style.height = Math.max(innerH, 200) + 'px';
    }

    function registerWindow(winId, iconId, closeId, w, h, onOpen) {
      const toggle = () => {
        const win = document.getElementById(winId);
        if (!win) return;
        if (win.style.display === 'none') {
          win.style.display = '';
          if (!win.classList.contains('is-absolute')) mobileWindowPos(win, w, h);
          bringToFront(win);
          if (onOpen) onOpen(win);
        } else {
          win.style.display = 'none';
        }
      };
      document.getElementById(iconId)?.addEventListener('click', (e) => { e.preventDefault(); toggle(); });
      document.getElementById(closeId)?.addEventListener('click', (e) => {
        e.stopPropagation();
        document.getElementById(winId).style.display = 'none';
      });
      return toggle;
    }

    const toggleDPaintWindow = registerWindow('dpaint-window', 'dpaint-icon', 'dpaint-close', 560, 480, () => sizeDPaintCanvas());
    const toggleDiskWindow = registerWindow('disk-window', 'disk-icon', 'disk-close', 420, 320, () => { sizeDiskCanvas(); animateDiskPie(); });

    function showDiskWindow() {
      const win = document.getElementById('disk-window');
      if (!win) return;
      if (win.style.display === 'none') {
        toggleDiskWindow();
      } else {
        bringToFront(win);
      }
    }

    // === File Manager ===
    function renderFileMgrList(activeId) {
      const list = document.getElementById('filemgr-list');
      if (!list) return;
      list.innerHTML = '';
      fileMgrItems.forEach((item) => {
        const row = document.createElement('div');
        row.className = 'fm-item' + (item.id === activeId ? ' active' : '');
        row.dataset.id = item.id;
        const icon = document.createElement('div');
        icon.className = 'fm-folder';
        const label = document.createElement('span');
        label.textContent = item.label;
        row.appendChild(icon);
        row.appendChild(label);
        row.addEventListener('click', () => {
          renderFileMgrList(item.id);
          drawDefrag(item.id);
          if (item.id === 'disk') showDiskWindow();
        });
        list.appendChild(row);
      });
    }

    const toggleFileMgrWindow = registerWindow('filemgr-window', 'filemgr-icon', 'filemgr-close', 600, 360, () => {
      sizeFileMgrCanvas(); renderFileMgrList('disk'); drawDefrag('disk');
    });

    initDPaint();

    window.addEventListener('resize', sizeDPaintCanvas);

    const dpaintWin = document.getElementById('dpaint-window');
    if (dpaintWin && 'ResizeObserver' in window) {
      const ro3 = new ResizeObserver(() => sizeDPaintCanvas());
      ro3.observe(dpaintWin);
    }

    // === Save painting ===
    function dpaintSave() {
      const btn = document.getElementById('dp-save');
      if (!btn || !dpaint.canvas) return;
      btn.classList.remove('saved', 'error');
      btn.classList.add('saving');
      btn.innerHTML = '...';

      dpaint.canvas.toBlob((blob) => {
        if (!blob) {
          btn.classList.remove('saving');
          btn.classList.add('error');
          btn.innerHTML = '!';
          setTimeout(() => resetSaveBtn(), 2000);
          return;
        }
        fetch('./paint/', {
          method: 'POST',
          headers: { 'Content-Type': 'image/png' },
          body: blob
        })
        .then(res => {
          if (!res.ok) throw new Error(res.statusText);
          return res.json();
        })
        .then(() => {
          btn.classList.remove('saving');
          btn.classList.add('saved');
          btn.innerHTML = '<svg viewBox="0 0 18 18"><path d="M4 9 L7 13 L14 5" stroke="#fff" stroke-width="2.5" fill="none"/></svg>';
          setTimeout(() => resetSaveBtn(), 2000);
        })
        .catch(() => {
          btn.classList.remove('saving');
          btn.classList.add('error');
          btn.innerHTML = '!';
          setTimeout(() => resetSaveBtn(), 2000);
        });
      }, 'image/png');
    }

    function resetSaveBtn() {
      const btn = document.getElementById('dp-save');
      if (!btn) return;
      btn.classList.remove('saving', 'saved', 'error');
      btn.innerHTML = '<svg viewBox="0 0 18 18"><path d="M3 1h10l3 3v11a2 2 0 01-2 2H3a2 2 0 01-2-2V3a2 2 0 012-2z" fill="none" stroke="#fff" stroke-width="1.5"/><rect x="5" y="1" width="7" height="5" rx="0.5" fill="#fff" opacity="0.7"/><rect x="5" y="10" width="8" height="6" rx="1" fill="#fff" opacity="0.5"/></svg>';
    }

    document.getElementById('dp-save')?.addEventListener('click', (e) => {
      e.stopPropagation();
      dpaintSave();
    });

    // Ctrl+S to save when DPaint is visible
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
        const win = document.getElementById('dpaint-window');
        if (win && win.style.display !== 'none') {
          e.preventDefault();
          dpaintSave();
        }
      }
    });

    // === Pictures window ===
    function loadPictures() {
      const body = document.getElementById('pictures-body');
      if (!body) return;
      fetch('./paint/')
        .then(res => res.ok ? res.json() : [])
        .then(list => {
          body.innerHTML = '';
          if (list.length === 0) {
            body.innerHTML = '<div class="pic-empty">No paintings saved yet</div>';
            return;
          }
          list.forEach(item => {
            const a = document.createElement('a');
            a.className = 'pic-thumb';
            a.href = item.url;
            a.draggable = true;
            a.dataset.filename = item.filename;
            a.addEventListener('click', (e) => {
              e.preventDefault();
              openPaintingWindow(item.filename, item.url);
            });
            a.addEventListener('dragstart', (e) => {
              e.dataTransfer.setData('text/plain', item.filename);
              e.dataTransfer.effectAllowed = 'move';
              a.classList.add('dragging');
            });
            a.addEventListener('dragend', () => {
              a.classList.remove('dragging');
            });
            const img = document.createElement('img');
            img.src = item.url;
            img.alt = item.filename;
            a.appendChild(img);
            // Extract date from filename: painting-{timestamp}.png
            const ts = parseInt(item.filename.replace('painting-', '').replace('.png', ''), 10);
            if (ts) {
              const d = new Date(ts);
              const label = document.createElement('span');
              label.textContent = d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
              a.appendChild(label);
            }
            body.appendChild(a);
          });
        })
        .catch(() => {
          body.innerHTML = '<div class="pic-empty">Could not load paintings</div>';
        });
    }

    const togglePicturesWindow = registerWindow('pictures-window', 'pictures-icon', 'pictures-close', 420, null, () => loadPictures());

    // === Open painting in a Workbench window ===
    function openPaintingWindow(filename, url) {
      const viewerId = 'viewer-' + safeId(filename);
      const safeSrc = safeUrl(url);
      // Remove existing viewer for same file
      const existing = document.getElementById(viewerId);
      if (existing) { bringToFront(existing); return; }

      const win = document.createElement('div');
      win.className = 'window';
      win.id = viewerId;
      mobileWindowPos(win, 360, null);
      if (document.documentElement.clientWidth >= 600) {
        const off = Math.round(Math.random() * 40 - 20);
        win.style.left = (parseInt(win.style.left) + off) + 'px';
        win.style.top = (parseInt(win.style.top) + off) + 'px';
      }
      const title = document.createElement('div');
      title.className = 'window-title';
      const close = document.createElement('div');
      close.className = 'close-gadget';
      const titleText = document.createElement('span');
      titleText.className = 'title-text';
      titleText.textContent = filename;
      title.appendChild(close);
      title.appendChild(titleText);

      const body = document.createElement('div');
      body.className = 'window-body painting-viewer';
      const img = document.createElement('img');
      img.src = safeSrc;
      img.alt = filename;
      body.appendChild(img);

      win.appendChild(title);
      win.appendChild(body);

      close.addEventListener('click', (e) => {
        e.stopPropagation();
        win.remove();
      });

      document.body.appendChild(win);
      bringToFront(win);
    }

    // === Drag pictures to trashcan to delete ===
    const trashEl = document.getElementById('trash-icon');
    if (trashEl) {
      trashEl.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        trashEl.classList.add('drag-over');
      });
      trashEl.addEventListener('dragleave', () => {
        trashEl.classList.remove('drag-over');
      });
      trashEl.addEventListener('drop', (e) => {
        e.preventDefault();
        trashEl.classList.remove('drag-over');
        guruMeditation();
      });
    }

    // === AmigaBASIC Interpreter ===
    const bas = {
      prog: {}, vars: {}, running: false, pc: 0,
      lines: [], callStack: [], forStack: [], whileStack: [],
      data: [], dataPtr: 0, inputResolve: null,
    };

    function basOut(s) {
      const el = document.getElementById('basic-output');
      if (!el) return;
      el.textContent += s + '\n';
      const body = el.closest('#basic-body');
      if (body) body.scrollTop = body.scrollHeight;
    }
    function basOutRaw(s) {
      const el = document.getElementById('basic-output');
      if (!el) return;
      el.textContent += s;
      const body = el.closest('#basic-body');
      if (body) body.scrollTop = body.scrollHeight;
    }
    function basCls() {
      const el = document.getElementById('basic-output');
      if (el) el.textContent = '';
    }
    let basAudioCtx = null;
    function basBeep() {
      try {
        if (!basAudioCtx) basAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const o = basAudioCtx.createOscillator();
        const g = basAudioCtx.createGain();
        o.connect(g); g.connect(basAudioCtx.destination);
        o.frequency.value = 440; g.gain.value = 0.1;
        o.start(); o.stop(basAudioCtx.currentTime + 0.15);
      } catch {}
    }

    // --- Tokenizer ---
    function basTok(src) {
      src = src.replace(/[\u201C\u201D\u201E\u201F\u2033\u2036]/g, '"').replace(/[\u2018\u2019\u201A\u201B\u2032\u2035]/g, "'");
      const t = [];
      let i = 0;
      while (i < src.length) {
        if (src[i] === ' ' || src[i] === '\t') { i++; continue; }
        if (src[i] === '"') {
          let s = ''; i++;
          while (i < src.length && src[i] !== '"') s += src[i++];
          if (i < src.length) i++;
          t.push(['S', s]); continue;
        }
        if (/\d/.test(src[i]) || (src[i] === '.' && /\d/.test(src[i+1]||''))) {
          let n = '';
          while (i < src.length && /[\d.]/.test(src[i])) n += src[i++];
          t.push(['N', parseFloat(n)]); continue;
        }
        if (src[i] === "'" ) { break; } // comment
        const tw = src.slice(i, i+2);
        if (['<>', '<=', '>='].includes(tw)) { t.push(['O', tw]); i += 2; continue; }
        if ('+-*/^=<>(),;:'.includes(src[i])) { t.push(['O', src[i]]); i++; continue; }
        if (/[a-zA-Z]/.test(src[i])) {
          let id = '';
          while (i < src.length && /[a-zA-Z0-9_]/.test(src[i])) id += src[i++];
          if (i < src.length && (src[i] === '$' || src[i] === '%')) id += src[i++];
          t.push(['I', id.toUpperCase()]); continue;
        }
        i++;
      }
      return t;
    }

    // --- Expression Parser ---
    class BasP {
      constructor(t) { this.t = t; this.p = 0; }
      pk() { return this.t[this.p] || null; }
      nx() { return this.t[this.p++] || null; }
      is(ty, v) { const t = this.pk(); return t && t[0] === ty && (v === undefined || t[1] === v); }
      eat(ty, v) { if (this.is(ty, v)) { this.p++; return true; } return false; }
      need(ty, v) { if (!this.eat(ty, v)) throw new Error('Expected ' + (v || ty)); }

      expr() { return this.bor(); }
      bor() {
        let l = this.band();
        while (this.is('I','OR')) { this.nx(); const r = this.band(); l = (l||r) ? -1 : 0; }
        return l;
      }
      band() {
        let l = this.bnot();
        while (this.is('I','AND')) { this.nx(); const r = this.bnot(); l = (l&&r) ? -1 : 0; }
        return l;
      }
      bnot() { if (this.eat('I','NOT')) return this.bnot() ? 0 : -1; return this.cmp(); }
      cmp() {
        let l = this.add();
        const ops = {'=':0,'<>':0,'<':0,'>':0,'<=':0,'>=':0};
        if (this.pk() && this.pk()[0]==='O' && this.pk()[1] in ops) {
          const op = this.nx()[1]; const r = this.add();
          if (op==='=') return l===r?-1:0; if (op==='<>') return l!==r?-1:0;
          if (op==='<') return l<r?-1:0;   if (op==='>') return l>r?-1:0;
          if (op==='<=') return l<=r?-1:0;  return l>=r?-1:0;
        }
        return l;
      }
      add() {
        let l = this.mul();
        while (this.is('O','+') || this.is('O','-')) {
          const op = this.nx()[1]; const r = this.mul();
          l = op==='+' ? (typeof l==='string'||typeof r==='string' ? String(l)+String(r) : l+r) : l-r;
        }
        return l;
      }
      mul() {
        let l = this.pw();
        while (this.is('O','*') || this.is('O','/') || this.is('I','MOD')) {
          const op = this.nx()[1]; const r = this.pw();
          if (op==='*') l=l*r; else if (op==='/') { if(r===0) throw new Error('Division by zero'); l=l/r; } else l=l%r;
        }
        return l;
      }
      pw() { let l = this.un(); if (this.eat('O','^')) l = Math.pow(l, this.un()); return l; }
      un() { if (this.eat('O','-')) return -this.un(); if (this.eat('O','+')) return this.un(); return this.at(); }
      at() {
        const t = this.pk();
        if (!t) throw new Error('Unexpected end');
        if (t[0]==='N') { this.nx(); return t[1]; }
        if (t[0]==='S') { this.nx(); return t[1]; }
        if (this.eat('O','(')) { const v = this.expr(); this.need('O',')'); return v; }
        if (t[0]==='I') {
          this.nx(); const n = t[1];
          if (this.eat('O','(')) {
            const a = [];
            if (!this.is('O',')')) { a.push(this.expr()); while (this.eat('O',',')) a.push(this.expr()); }
            this.need('O',')');
            return this.fn(n, a);
          }
          if (n==='RND') return Math.random();
          if (n==='TIMER') return Math.floor(Date.now()/1000);
          if (n==='PI') return Math.PI;
          return bas.vars[n] !== undefined ? bas.vars[n] : (n.endsWith('$') ? '' : 0);
        }
        throw new Error('Syntax error');
      }
      fn(n, a) {
        const f = {
          INT:()=>Math.floor(a[0]), ABS:()=>Math.abs(a[0]), SQR:()=>Math.sqrt(a[0]),
          SIN:()=>Math.sin(a[0]), COS:()=>Math.cos(a[0]), TAN:()=>Math.tan(a[0]),
          ATN:()=>Math.atan(a[0]), LOG:()=>Math.log(a[0]), EXP:()=>Math.exp(a[0]),
          SGN:()=>Math.sign(a[0]), RND:()=>Math.random()*(a[0]||1),
          LEN:()=>String(a[0]).length,
          'LEFT$':()=>String(a[0]).slice(0,a[1]),
          'RIGHT$':()=>String(a[0]).slice(-(a[1]||0)),
          'MID$':()=>String(a[0]).slice((a[1]||1)-1, a[2]?(a[1]||1)-1+a[2]:undefined),
          'CHR$':()=>String.fromCharCode(a[0]),
          ASC:()=>String(a[0]).charCodeAt(0)||0,
          'STR$':()=>String(a[0]),
          VAL:()=>parseFloat(a[0])||0,
          TAB:()=>' '.repeat(Math.max(0,Math.floor(a[0]))),
          PEEK:()=>Math.floor(Math.random()*256),
          'UCASE$':()=>String(a[0]).toUpperCase(),
          'LCASE$':()=>String(a[0]).toLowerCase(),
        };
        if (f[n]) return f[n]();
        throw new Error('Unknown function: ' + n);
      }
    }

    function basEval(toks, pos) {
      const p = new BasP(toks.slice(pos));
      const v = p.expr();
      return [v, pos + p.p];
    }

    // --- Block-level skip helpers ---
    function basSkipIf(findElse) {
      let depth = 0;
      while (bas.pc < bas.lines.length) {
        const u = bas.prog[bas.lines[bas.pc]].trim().toUpperCase();
        if (/^IF\b/.test(u) && /\bTHEN\s*$/.test(u)) depth++;
        else if (/^ELSE\b/.test(u) && depth === 0 && findElse) { bas.pc++; return; }
        else if (/^END\s*IF\b/.test(u)) { if (depth === 0) { bas.pc++; return; } depth--; }
        bas.pc++;
      }
    }
    function basSkipWend() {
      let depth = 0;
      while (bas.pc < bas.lines.length) {
        const u = bas.prog[bas.lines[bas.pc]].trim().toUpperCase();
        if (/^WHILE\b/.test(u)) depth++;
        else if (/^WEND\b/.test(u)) { if (depth === 0) { bas.pc++; return; } depth--; }
        bas.pc++;
      }
    }

    // --- Statement execution ---
    async function basExecStmt(toks, pos) {
      if (pos >= toks.length) return pos;
      const t = toks[pos];

      if (t[0] === 'I' && t[1] === 'REM') return toks.length;

      // PRINT
      if (t[0] === 'I' && t[1] === 'PRINT') {
        pos++;
        let out = '', nl = true;
        while (pos < toks.length && !(toks[pos][0]==='O' && toks[pos][1]===':')) {
          if (toks[pos][0]==='O' && toks[pos][1]===';') { nl = false; pos++; continue; }
          if (toks[pos][0]==='O' && toks[pos][1]===',') { out += '\t'; nl = false; pos++; continue; }
          const [v, np] = basEval(toks, pos); pos = np;
          out += (v == null) ? '' : String(v);
          nl = true;
        }
        if (nl) basOut(out); else basOutRaw(out);
        return pos;
      }

      // INPUT
      if (t[0] === 'I' && t[1] === 'INPUT') {
        pos++;
        let prompt = '';
        if (toks[pos] && toks[pos][0] === 'S') {
          prompt = toks[pos][1]; pos++;
          if (toks[pos] && toks[pos][0] === 'O' && (toks[pos][1]===';'||toks[pos][1]===',')) pos++;
        }
        if (!toks[pos] || toks[pos][0] !== 'I') throw new Error('Expected variable');
        const vn = toks[pos][1]; pos++;
        basOutRaw(prompt + '? ');
        const val = await new Promise(r => { bas.inputResolve = r; });
        bas.vars[vn] = vn.endsWith('$') ? val : (parseFloat(val) || 0);
        return pos;
      }

      // LET
      if (t[0] === 'I' && t[1] === 'LET') {
        pos++;
        if (!toks[pos] || toks[pos][0] !== 'I') throw new Error('Expected variable');
        const vn = toks[pos][1]; pos++;
        if (!toks[pos] || toks[pos][1] !== '=') throw new Error('Expected =');
        pos++;
        const [v, np] = basEval(toks, pos);
        bas.vars[vn] = v;
        return np;
      }

      // Single-line IF: IF expr THEN stmt [ELSE stmt]
      if (t[0] === 'I' && t[1] === 'IF') {
        pos++;
        let thenPos = -1;
        for (let i = pos; i < toks.length; i++) {
          if (toks[i][0] === 'I' && toks[i][1] === 'THEN') { thenPos = i; break; }
        }
        if (thenPos === -1) throw new Error('IF without THEN');
        const condToks = toks.slice(pos, thenPos);
        const cond = new BasP(condToks).expr();
        pos = thenPos + 1;
        if (pos >= toks.length) return pos; // multi-line handled at block level

        // Check if after THEN is a line number (GOTO shorthand)
        if (toks[pos][0] === 'N') {
          if (cond) {
            const ln = toks[pos][1];
            const idx = bas.lines.indexOf(ln);
            if (idx === -1) throw new Error('Undefined line ' + ln);
            bas.pc = idx;
          }
          return toks.length;
        }

        // Find ELSE at same nesting level
        let elsePos = -1;
        for (let i = pos; i < toks.length; i++) {
          if (toks[i][0] === 'I' && toks[i][1] === 'ELSE') { elsePos = i; break; }
        }

        if (cond) {
          const end = elsePos !== -1 ? elsePos : toks.length;
          while (pos < end) {
            if (toks[pos][0]==='O' && toks[pos][1]===':') { pos++; continue; }
            pos = await basExecStmt(toks, pos);
          }
        } else if (elsePos !== -1) {
          pos = elsePos + 1;
          while (pos < toks.length) {
            if (toks[pos][0]==='O' && toks[pos][1]===':') { pos++; continue; }
            pos = await basExecStmt(toks, pos);
          }
        }
        return toks.length;
      }

      // FOR var = start TO end [STEP step]
      if (t[0] === 'I' && t[1] === 'FOR') {
        pos++;
        if (!toks[pos] || toks[pos][0] !== 'I') throw new Error('Expected variable');
        const vn = toks[pos][1]; pos++;
        if (!toks[pos] || toks[pos][1] !== '=') throw new Error('Expected =');
        pos++;
        const [sv, np1] = basEval(toks, pos); pos = np1;
        if (!toks[pos] || toks[pos][1] !== 'TO') throw new Error('Expected TO');
        pos++;
        const [ev, np2] = basEval(toks, pos); pos = np2;
        let step = 1;
        if (toks[pos] && toks[pos][0]==='I' && toks[pos][1]==='STEP') {
          pos++;
          const [stv, np3] = basEval(toks, pos); step = stv; pos = np3;
        }
        bas.vars[vn] = sv;
        bas.forStack.push({ v: vn, end: ev, step, line: bas.pc });
        return pos;
      }

      // NEXT
      if (t[0] === 'I' && t[1] === 'NEXT') {
        pos++;
        if (toks[pos] && toks[pos][0]==='I') pos++; // skip optional var name
        if (bas.forStack.length === 0) throw new Error('NEXT without FOR');
        const f = bas.forStack[bas.forStack.length - 1];
        bas.vars[f.v] += f.step;
        const done = f.step > 0 ? bas.vars[f.v] > f.end : bas.vars[f.v] < f.end;
        if (!done) { bas.pc = f.line; } else { bas.forStack.pop(); }
        return pos;
      }

      // GOTO
      if (t[0] === 'I' && t[1] === 'GOTO') {
        pos++;
        const [ln] = basEval(toks, pos);
        const idx = bas.lines.indexOf(ln);
        if (idx === -1) throw new Error('Undefined line ' + ln);
        bas.pc = idx;
        return toks.length;
      }

      // GOSUB
      if (t[0] === 'I' && t[1] === 'GOSUB') {
        pos++;
        const [ln] = basEval(toks, pos);
        const idx = bas.lines.indexOf(ln);
        if (idx === -1) throw new Error('Undefined line ' + ln);
        bas.callStack.push(bas.pc);
        bas.pc = idx;
        return toks.length;
      }

      // RETURN
      if (t[0]==='I' && t[1]==='RETURN') {
        if (bas.callStack.length === 0) throw new Error('RETURN without GOSUB');
        bas.pc = bas.callStack.pop();
        return toks.length;
      }

      // END / STOP
      if (t[0]==='I' && (t[1]==='END'||t[1]==='STOP')) { bas.running = false; return toks.length; }

      // CLS
      if (t[0]==='I' && t[1]==='CLS') { basCls(); return pos + 1; }

      // BEEP
      if (t[0]==='I' && t[1]==='BEEP') { basBeep(); return pos + 1; }

      // SLEEP
      if (t[0]==='I' && t[1]==='SLEEP') {
        pos++;
        const [s] = basEval(toks, pos);
        await new Promise(r => setTimeout(r, Math.min(s * 1000, 10000)));
        return toks.length;
      }

      // DIM / DATA  no-op at runtime
      if (t[0]==='I' && (t[1]==='DIM'||t[1]==='DATA')) return toks.length;

      // READ var [, var...]
      if (t[0]==='I' && t[1]==='READ') {
        pos++;
        while (pos < toks.length) {
          if (!toks[pos] || toks[pos][0] !== 'I') break;
          const vn = toks[pos][1]; pos++;
          if (bas.dataPtr >= bas.data.length) throw new Error('Out of DATA');
          bas.vars[vn] = bas.data[bas.dataPtr++];
          if (toks[pos] && toks[pos][0]==='O' && toks[pos][1]===',') pos++;
          else break;
        }
        return pos;
      }

      // RESTORE
      if (t[0]==='I' && t[1]==='RESTORE') { bas.dataPtr = 0; return pos + 1; }

      // POKE  no-op
      if (t[0]==='I' && t[1]==='POKE') return toks.length;

      // Assignment: var = expr
      if (t[0]==='I' && pos+1 < toks.length && toks[pos+1][0]==='O' && toks[pos+1][1]==='=') {
        const vn = t[1]; pos += 2;
        const [v, np] = basEval(toks, pos);
        bas.vars[vn] = v;
        return np;
      }

      throw new Error('Syntax error');
    }

    async function basExecLine(src) {
      const toks = basTok(src);
      let pos = 0;
      while (pos < toks.length) {
        if (toks[pos][0]==='O' && toks[pos][1]===':') { pos++; continue; }
        pos = await basExecStmt(toks, pos);
      }
    }

    // --- Data collection ---
    function basCollectData() {
      bas.data = []; bas.dataPtr = 0;
      for (const ln of bas.lines) {
        const src = bas.prog[ln].trim();
        if (/^DATA\b/i.test(src)) {
          src.slice(4).split(',').forEach(v => {
            v = v.trim();
            if (v.startsWith('"') && v.endsWith('"')) bas.data.push(v.slice(1,-1));
            else bas.data.push(isNaN(v) ? v : parseFloat(v));
          });
        }
      }
    }

    // --- Program run ---
    async function basRun() {
      bas.lines = Object.keys(bas.prog).map(Number).sort((a,b) => a-b);
      bas.pc = 0; bas.running = true;
      bas.callStack = []; bas.forStack = []; bas.whileStack = [];
      bas.vars = {};
      basCollectData();
      let cycles = 0;

      while (bas.running && bas.pc < bas.lines.length) {
        const lineNum = bas.lines[bas.pc];
        const src = bas.prog[lineNum].trim();
        const upper = src.toUpperCase();
        bas.pc++;

        try {
          // Block-level: multi-line IF
          if (/^IF\b/.test(upper) && /\bTHEN\s*$/.test(upper)) {
            const condSrc = src.substring(
              src.search(/^if\b/i) + 2,
              src.search(/\bthen\s*$/i)
            ).trim();
            const cond = new BasP(basTok(condSrc)).expr();
            if (!cond) basSkipIf(true);
            continue;
          }
          if (/^ELSE\b/.test(upper)) { basSkipIf(false); continue; }
          if (/^END\s*IF\b/.test(upper)) continue;

          // Block-level: WHILE/WEND
          if (/^WHILE\b/.test(upper)) {
            const condSrc = src.slice(5).trim();
            const cond = new BasP(basTok(condSrc)).expr();
            const idx = bas.pc - 1;
            if (cond) {
              if (!bas.whileStack.length || bas.whileStack[bas.whileStack.length-1] !== idx)
                bas.whileStack.push(idx);
            } else {
              if (bas.whileStack.length && bas.whileStack[bas.whileStack.length-1] === idx)
                bas.whileStack.pop();
              basSkipWend();
            }
            continue;
          }
          if (/^WEND\b/.test(upper)) {
            if (!bas.whileStack.length) throw new Error('WEND without WHILE');
            bas.pc = bas.whileStack[bas.whileStack.length-1];
            continue;
          }

          // Regular statement
          await basExecLine(src);

        } catch(e) {
          basOut('?' + e.message + ' in ' + lineNum);
          bas.running = false;
        }

        if (++cycles % 100 === 0) await new Promise(r => setTimeout(r, 0));
        if (cycles > 3000) {
          basOut('?Out of memory in ' + bas.lines[bas.pc - 1]);
          bas.running = false;
          guruMeditation();
        }
      }
      bas.running = false;
    }

    // --- Input handler ---
    async function basHandleInput(text) {
      if (bas.inputResolve) {
        basOut(text);
        const r = bas.inputResolve;
        bas.inputResolve = null;
        r(text);
        return;
      }

      const trimmed = text.trim();
      if (!trimmed) { basOut('Ok'); return; }

      basOut(text);
      const m = trimmed.match(/^(\d+)\s*(.*)/);
      if (m) {
        const num = parseInt(m[1]);
        if (m[2] === '') delete bas.prog[num];
        else bas.prog[num] = m[2];
        basOut('Ok');
        return;
      }

      const upper = trimmed.toUpperCase();

      if (upper === 'RUN') { await basRun(); basOut('Ok'); return; }

      if (upper.startsWith('LIST')) {
        const lines = Object.keys(bas.prog).map(Number).sort((a,b) => a-b);
        lines.forEach(n => basOut(n + ' ' + bas.prog[n]));
        basOut('Ok'); return;
      }

      if (upper === 'NEW') { bas.prog = {}; bas.vars = {}; basOut('Ok'); return; }

      if (upper === 'HELP') {
        basOut('Commands: PRINT, LET, INPUT, IF/THEN/ELSE/END IF');
        basOut('FOR/NEXT, WHILE/WEND, GOTO, GOSUB/RETURN');
        basOut('CLS, BEEP, SLEEP, READ, DATA, DIM');
        basOut('RUN, LIST, NEW, REM, END, SKILLS');
        basOut('');
        basOut('Type line numbers to store a program:');
        basOut('  10 PRINT "Hello, World!"');
        basOut('  20 GOTO 10');
        basOut('  RUN');
        basOut('Ok'); return;
      }

      if (upper === 'SKILLS') {
        basOut('=== Skills ===');
        basOut('Languages:  SQL, Python, Bash, Lua, GDScript');
        basOut('Tools:      SSMS, Access, Navision, Excel, PowerBI');
        basOut('Data:       Pandas, Matplotlib, visualization');
        basOut('Systems:    Unix & Windows sysadmin');
        basOut('Creative:   Photoshop, Premiere, Ableton');
        basOut('Other:      Metadata standards, digitization');
        basOut('            Studio technician (music)');
        basOut('Speaks:     Danish, English');
        basOut('Ok'); return;
      }

      try {
        await basExecLine(trimmed);
        basOut('Ok');
      } catch(e) {
        basOut('?' + e.message);
        basOut('Ok');
      }
    }

    // --- BASIC UI ---
    function basInit() {
      const input = document.getElementById('basic-input');
      if (!input) return;
      basOut('AmigaBASIC v3.4');
      basOut('(c) 2026 Workbench Edition');
      basOut('32768 bytes free');
      basOut('Ok');

      input.addEventListener('keydown', (e) => {
        if ((e.key === 'c' && (e.ctrlKey || e.metaKey)) || e.key === 'Escape') {
          if (bas.running) {
            e.preventDefault();
            bas.running = false;
            basOut('Break');
            basOut('Ok');
            return;
          }
        }
        if (e.key === 'Enter') {
          const text = input.value;
          input.value = '';
          basHandleInput(text);
        }
      });
      document.getElementById('basic-body')?.addEventListener('click', () => input.focus());
    }

    const toggleBasicWindow = registerWindow('basic-window', 'basic-icon', 'basic-close', 480, 380, () => {
      document.getElementById('basic-input')?.focus();
    });

    function sizeBasicBody() {
      const win = document.getElementById('basic-window');
      const body = document.getElementById('basic-body');
      if (!win || !body || win.style.display === 'none') return;
      const title = win.querySelector('.window-title');
      const inner = win.clientHeight - (title ? title.offsetHeight : 0) - 4;
      body.style.height = Math.max(inner, 100) + 'px';
    }

    // === Mail window ===
    const toggleMailWindow = registerWindow('mail-window', 'mail-icon', 'mail-close', 420, null);
    document.getElementById('mail-send-btn')?.addEventListener('click', () => {
      const subjectRaw = document.getElementById('mail-subject')?.value || '';
      const bodyRaw = document.getElementById('mail-msg')?.value || '';
      if (!subjectRaw.trim() && !bodyRaw.trim()) return;
      const subject = encodeURIComponent(subjectRaw);
      const body = encodeURIComponent(bodyRaw);
      window.location.href = 'mailto:emilvisti@gmail.com?subject=' + subject + '&body=' + body;
    });

    // === Timeline window ===
    const timelineEntries = [
      { type: 'experience', title: 'Data Specialist', org: 'Gramex', start: 2017, end: null },
      { type: 'experience', title: 'Metadata Expert', org: 'Sandrew Metronome', start: 2014, end: 2016 },
      { type: 'experience', title: 'Asst. Producer  Video / Music / Graphics', org: 'Big Beard Productions', start: 2012, end: 2014 },
      { type: 'experience', title: 'Writer  SEO, Articles, Podcasts', org: 'Rotation.dk', start: 2012, end: 2015 },
      { type: 'experience', title: 'PR Associate', org: 'ORA', start: 2011, end: 2012 },
      { type: 'education', title: 'Librarian DB', org: 'IVA Aalborg', start: 2014, end: 2015 },
      { type: 'education', title: 'BSc Information Science', org: 'IVA Aalborg', start: 2008, end: 2014 },
      { type: 'education', title: 'Gymnasium', org: 'Dronninglund', start: 2003, end: 2006 }
    ];

    function buildTimelineMap() {
      const grid = document.getElementById('timeline-grid');
      const detail = document.getElementById('timeline-detail');
      if (!grid || !detail) return;

      const nowYear = new Date().getFullYear();
      const normalized = timelineEntries.map((e) => ({
        ...e,
        end: e.end || nowYear,
        openEnd: e.end == null
      }));
      const minYear = Math.min(...normalized.map(e => e.start));
      const maxYear = Math.max(...normalized.map(e => e.end));
      const years = [];
      for (let y = minYear; y <= maxYear; y++) years.push(y);

      grid.innerHTML = '';
      grid.style.gridTemplateColumns = `90px repeat(${years.length}, 14px)`;

      const header = document.createElement('div');
      header.className = 'timeline-label';
      header.textContent = 'Year';
      grid.appendChild(header);

      years.forEach((y) => {
        const cell = document.createElement('div');
        cell.className = 'timeline-year';
        cell.textContent = String(y).slice(2);
        grid.appendChild(cell);
      });

      function setDetail(year, type, entries) {
        detail.innerHTML = '';
        const title = document.createElement('div');
        title.className = 'highlight';
        title.textContent = `${year}  ${type === 'experience' ? 'Experience' : 'Education'}`;
        detail.appendChild(title);

        if (!entries.length) {
          const empty = document.createElement('div');
          empty.textContent = 'No entries';
          detail.appendChild(empty);
          return;
        }

        entries.forEach((e) => {
          const line = document.createElement('div');
          const endLabel = e.openEnd ? 'Present' : e.end;
          line.textContent = `${e.title}  ${e.org} (${e.start}${endLabel})`;
          detail.appendChild(line);
        });
      }

      function addRow(label, type) {
        const rowLabel = document.createElement('div');
        rowLabel.className = 'timeline-label';
        rowLabel.textContent = label;
        grid.appendChild(rowLabel);

        years.forEach((y) => {
          const entries = normalized.filter(e => e.type === type && y >= e.start && y <= e.end);
          const cell = document.createElement('div');
          cell.className = 'timeline-cell';
          if (entries.length) {
            cell.classList.add(type === 'experience' ? 'active-exp' : 'active-edu');
            if (entries.length > 1) cell.classList.add('multi');
          }
          cell.addEventListener('mouseenter', () => setDetail(y, type, entries));
          cell.addEventListener('click', () => setDetail(y, type, entries));
          grid.appendChild(cell);
        });
      }

      addRow('Experience', 'experience');
      addRow('Education', 'education');

      grid.onmouseleave = () => {
        detail.textContent = 'Hover a block to see details.';
      };
    }

    const toggleTimelineWindow = registerWindow('timeline-window', 'timeline-icon', 'timeline-close', 520, 360, () => buildTimelineMap());

    // === Main (CV) window ===
    const toggleMainWindow = registerWindow('main-window', 'cv-icon', 'main-close', 560, null, (win) => {
      win.classList.add('open');
      sizeMainWindowBody();
    });

    // === Demo window ===
    const toggleDemoWindow = registerWindow('demo-window', 'demo-icon', 'demo-close', 480, 260, () => sizeDemoCanvas());

    // === Print CV ===
    document.getElementById('print-icon')?.addEventListener('click', (e) => {
      e.preventDefault();
      window.print();
    });

    basInit();
    window.addEventListener('resize', sizeBasicBody);
    const basicWin = document.getElementById('basic-window');
    if (basicWin && 'ResizeObserver' in window) {
      new ResizeObserver(() => sizeBasicBody()).observe(basicWin);
    }
  </script>
</body>
</html>
